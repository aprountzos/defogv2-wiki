"use strict";(globalThis.webpackChunkdefogv_2_wiki=globalThis.webpackChunkdefogv_2_wiki||[]).push([[7141],{7483:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>a,default:()=>h,frontMatter:()=>t,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"architecture/components/discovery-controller","title":"Discovery Controller","description":"Event-driven service labeling for Linkerd multi-cluster export","source":"@site/docs/architecture/components/discovery-controller.mdx","sourceDirName":"architecture/components","slug":"/architecture/components/discovery-controller","permalink":"/defogv2-wiki/docs/architecture/components/discovery-controller","draft":false,"unlisted":false,"editUrl":"https://github.com/aprountzos/defogv2-wiki/tree/main/docs/docs/architecture/components/discovery-controller.mdx","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"title":"Discovery Controller","description":"Event-driven service labeling for Linkerd multi-cluster export","sidebar_position":1},"sidebar":"tutorialSidebar","previous":{"title":"API Reference","permalink":"/defogv2-wiki/docs/architecture/api-reference"},"next":{"title":"Metrics Monitor","permalink":"/defogv2-wiki/docs/architecture/components/metrics-monitor"}}');var i=r(4848),l=r(8453);const t={title:"Discovery Controller",description:"Event-driven service labeling for Linkerd multi-cluster export",sidebar_position:1},a="Discovery Controller",o={},c=[{value:"Overview",id:"overview",level:2},{value:"Purpose",id:"purpose",level:2},{value:"How It Works",id:"how-it-works",level:2},{value:"Event-Driven Architecture",id:"event-driven-architecture",level:3},{value:"Labeling Logic",id:"labeling-logic",level:3},{value:"Service Filtering",id:"service-filtering",level:3},{value:"Configuration",id:"configuration",level:2},{value:"Command-Line Flags",id:"command-line-flags",level:3},{value:"ConfigMap Settings",id:"configmap-settings",level:3},{value:"RBAC Requirements",id:"rbac-requirements",level:3},{value:"Events Emitted",id:"events-emitted",level:2},{value:"ServiceLabeledEvent",id:"servicelabeledevent",level:3},{value:"ServiceAlreadyLabeled",id:"servicealreadylabeled",level:3},{value:"Deployment",id:"deployment",level:2},{value:"Kubernetes Manifest",id:"kubernetes-manifest",level:3},{value:"Operational Characteristics",id:"operational-characteristics",level:2},{value:"Resource Usage",id:"resource-usage",level:3},{value:"Performance",id:"performance",level:3},{value:"Monitoring",id:"monitoring",level:2},{value:"Key Metrics",id:"key-metrics",level:3},{value:"Health Checks",id:"health-checks",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Issue: Services Not Being Labeled",id:"issue-services-not-being-labeled",level:3},{value:"Issue: Watch Connection Lost",id:"issue-watch-connection-lost",level:3},{value:"Issue: Event Emission Failures",id:"issue-event-emission-failures",level:3},{value:"Issue: High Memory Usage",id:"issue-high-memory-usage",level:3},{value:"Advanced Configuration",id:"advanced-configuration",level:2},{value:"Multiple Namespace Watching",id:"multiple-namespace-watching",level:3},{value:"Custom Export Labels",id:"custom-export-labels",level:3},{value:"Skipping Individual Services",id:"skipping-individual-services",level:3},{value:"Adjusting Log Verbosity",id:"adjusting-log-verbosity",level:3},{value:"API Endpoints",id:"api-endpoints",level:2},{value:"GET /health",id:"get-health",level:3},{value:"GET /ready",id:"get-ready",level:3},{value:"GET /stats",id:"get-stats",level:3},{value:"GET /metrics",id:"get-metrics",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"1. Start Small",id:"1-start-small",level:3},{value:"2. Use Single Replica",id:"2-use-single-replica",level:3},{value:"3. Monitor Label Success",id:"3-monitor-label-success",level:3},{value:"4. Enable Verbose Logging During Debugging",id:"4-enable-verbose-logging-during-debugging",level:3},{value:"5. Use PodDisruptionBudget",id:"5-use-poddisruptionbudget",level:3},{value:"Integration Points",id:"integration-points",level:2},{value:"With Linkerd",id:"with-linkerd",level:3},{value:"With Orchestrator",id:"with-orchestrator",level:3},{value:"Source Code Reference",id:"source-code-reference",level:2},{value:"Related Documentation",id:"related-documentation",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"discovery-controller",children:"Discovery Controller"})}),"\n",(0,i.jsx)(n.p,{children:"The Discovery Controller is a Kubernetes operator that automatically ensures all services in specified namespaces are properly labeled for Linkerd multi-cluster export using event-driven architecture."}),"\n",(0,i.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsx)(n.mermaid,{value:"graph TB\r\n    K8S[Kubernetes API] --\x3e|watch events| DC[Discovery Controller]\r\n    DC --\x3e|Added event| SVC[Services]\r\n    DC --\x3e|Modified event| SVC\r\n    DC --\x3e|add labels| SVC\r\n    DC --\x3e|emit events| ORCH[Orchestrator]\r\n    \r\n    style DC fill:#e1f5ff\r\n    style SVC fill:#e1ffe1"}),"\n",(0,i.jsx)(n.h2,{id:"purpose",children:"Purpose"}),"\n",(0,i.jsx)(n.p,{children:"The Discovery Controller serves as the entry point for service discovery in Defog v2. It ensures that:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"All services are exportable"})," - Adds Linkerd export labels automatically"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Event-driven processing"})," - Reacts to service creation/modification immediately"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Zero manual intervention"})," - Services are auto-discovered on creation"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Audit trail"})," - Events emitted when services are labeled"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"how-it-works",children:"How It Works"}),"\n",(0,i.jsx)(n.h3,{id:"event-driven-architecture",children:"Event-Driven Architecture"}),"\n",(0,i.jsx)(n.mermaid,{value:'sequenceDiagram\r\n    participant K8S as Kubernetes API\r\n    participant DC as Discovery Controller\r\n    participant SVC as Service\r\n    participant ORCH as Orchestrator\r\n    \r\n    Note over DC: On Startup\r\n    DC->>K8S: List all services (initial sync)\r\n    K8S--\x3e>DC: Existing services\r\n    DC->>DC: Process each service\r\n    \r\n    Note over DC: Watch Phase\r\n    K8S->>DC: Service Added Event\r\n    DC->>DC: Check for export label\r\n    \r\n    alt Label Missing\r\n        DC->>SVC: Update service with labels\r\n        SVC--\x3e>DC: Updated\r\n        DC->>ORCH: ServiceLabeledEvent\r\n        Note over DC: Log: "\u2705 Labeled service/api"\r\n    else Label Exists\r\n        DC->>ORCH: ServiceAlreadyLabeled\r\n        Note over DC: Skip (already exported)\r\n    end'}),"\n",(0,i.jsx)(n.h3,{id:"labeling-logic",children:"Labeling Logic"}),"\n",(0,i.jsx)(n.p,{children:"The controller adds two labels to each service:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:'// Export label for Linkerd\r\nsvc.Labels["mirror.linkerd.io/exported"] = "true"\r\n\r\n// Management label\r\nsvc.Labels["app.kubernetes.io/managed-by"] = "defog-v2"\n'})}),"\n",(0,i.jsx)(n.h3,{id:"service-filtering",children:"Service Filtering"}),"\n",(0,i.jsx)(n.p,{children:"Services are automatically skipped if they:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:['Start with "kubernetes" (e.g., ',(0,i.jsx)(n.code,{children:"kubernetes"})," service)"]}),"\n",(0,i.jsxs)(n.li,{children:["Are in the ",(0,i.jsx)(n.code,{children:"kube-system"})," namespace"]}),"\n",(0,i.jsxs)(n.li,{children:["Have annotation ",(0,i.jsx)(n.code,{children:'defog.io/skip-export: "true"'})]}),"\n",(0,i.jsxs)(n.li,{children:["Are headless services (",(0,i.jsx)(n.code,{children:"ClusterIP: None"}),")"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,i.jsx)(n.h3,{id:"command-line-flags",children:"Command-Line Flags"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'-namespaces         # Comma-separated namespaces (default: "default")\r\n-export-label       # Label key (default: "mirror.linkerd.io/exported")\r\n-export-value       # Label value (default: "true")\r\n-managed-by         # Managed-by value (default: "defog-v2")\r\n-orchestrator-url   # Orchestrator URL (default: "http://orchestrator:8080")\r\n-http-port          # HTTP port (default: 8080)\r\n-enable-events      # Enable event emission (default: true)\r\n-v                  # Log verbosity (default: 0, max: 3)\n'})}),"\n",(0,i.jsx)(n.h3,{id:"configmap-settings",children:"ConfigMap Settings"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'apiVersion: v1\r\nkind: ConfigMap\r\nmetadata:\r\n  name: discovery-controller-config\r\n  namespace: defog-system\r\ndata:\r\n  NAMESPACES: "default,production,staging"\r\n  EXPORT_LABEL: "mirror.linkerd.io/exported"\r\n  EXPORT_VALUE: "true"\r\n  MANAGED_BY: "defog-v2"\r\n  ORCHESTRATOR_URL: "http://orchestrator:8080"\r\n  ENABLE_EVENTS: "true"\r\n  HTTP_PORT: "8080"\r\n  LOG_LEVEL: "2"\n'})}),"\n",(0,i.jsx)(n.h3,{id:"rbac-requirements",children:"RBAC Requirements"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'apiVersion: rbac.authorization.k8s.io/v1\r\nkind: ClusterRole\r\nmetadata:\r\n  name: discovery-controller-role\r\nrules:\r\n- apiGroups: [""]\r\n  resources: ["services"]\r\n  verbs: ["get", "list", "watch", "update", "patch"]\r\n- apiGroups: [""]\r\n  resources: ["namespaces"]\r\n  verbs: ["get", "list"]\n'})}),"\n",(0,i.jsx)(n.h2,{id:"events-emitted",children:"Events Emitted"}),"\n",(0,i.jsx)(n.h3,{id:"servicelabeledevent",children:"ServiceLabeledEvent"}),"\n",(0,i.jsx)(n.p,{children:"Emitted when a service is successfully labeled:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\r\n  "type": "ServiceLabeled",\r\n  "serviceName": "api",\r\n  "namespace": "default",\r\n  "action": "labeled",\r\n  "labels": {\r\n    "mirror.linkerd.io/exported": "true",\r\n    "app.kubernetes.io/managed-by": "defog-v2"\r\n  },\r\n  "timestamp": "2024-01-15T10:30:00Z"\r\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"servicealreadylabeled",children:"ServiceAlreadyLabeled"}),"\n",(0,i.jsx)(n.p,{children:"Emitted when a service already has the correct labels:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\r\n  "type": "ServiceAlreadyLabeled",\r\n  "serviceName": "api",\r\n  "namespace": "default",\r\n  "action": "already_labeled",\r\n  "labels": {\r\n    "mirror.linkerd.io/exported": "true"\r\n  },\r\n  "timestamp": "2024-01-15T10:30:00Z"\r\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"deployment",children:"Deployment"}),"\n",(0,i.jsx)(n.h3,{id:"kubernetes-manifest",children:"Kubernetes Manifest"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'apiVersion: apps/v1\r\nkind: Deployment\r\nmetadata:\r\n  name: discovery-controller\r\n  namespace: defog-system\r\nspec:\r\n  replicas: 1\r\n  selector:\r\n    matchLabels:\r\n      app: discovery-controller\r\n  template:\r\n    metadata:\r\n      labels:\r\n        app: discovery-controller\r\n    spec:\r\n      serviceAccountName: discovery-controller\r\n      containers:\r\n      - name: discovery-controller\r\n        image: your-registry.io/discovery-controller:v2.0.0\r\n        args:\r\n          - -namespaces=$(NAMESPACES)\r\n          - -export-label=$(EXPORT_LABEL)\r\n          - -export-value=$(EXPORT_VALUE)\r\n          - -managed-by=$(MANAGED_BY)\r\n          - -orchestrator-url=$(ORCHESTRATOR_URL)\r\n          - -http-port=$(HTTP_PORT)\r\n          - -enable-events=$(ENABLE_EVENTS)\r\n          - -v=$(LOG_LEVEL)\r\n        envFrom:\r\n        - configMapRef:\r\n            name: discovery-controller-config\r\n        ports:\r\n        - name: http\r\n          containerPort: 8080\r\n        resources:\r\n          requests:\r\n            cpu: 100m\r\n            memory: 128Mi\r\n          limits:\r\n            cpu: 200m\r\n            memory: 256Mi\r\n        livenessProbe:\r\n          httpGet:\r\n            path: /health\r\n            port: 8080\r\n          initialDelaySeconds: 10\r\n          periodSeconds: 30\r\n        readinessProbe:\r\n          httpGet:\r\n            path: /ready\r\n            port: 8080\r\n          initialDelaySeconds: 5\r\n          periodSeconds: 10\r\n        securityContext:\r\n          allowPrivilegeEscalation: false\r\n          runAsNonRoot: true\r\n          runAsUser: 65532\r\n          capabilities:\r\n            drop: ["ALL"]\r\n          readOnlyRootFilesystem: true\n'})}),"\n",(0,i.jsx)(n.h2,{id:"operational-characteristics",children:"Operational Characteristics"}),"\n",(0,i.jsx)(n.h3,{id:"resource-usage",children:"Resource Usage"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Metric"}),(0,i.jsx)(n.th,{children:"Typical"}),(0,i.jsx)(n.th,{children:"Maximum"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"CPU"}),(0,i.jsx)(n.td,{children:"50m"}),(0,i.jsx)(n.td,{children:"200m"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Memory"}),(0,i.jsx)(n.td,{children:"100Mi"}),(0,i.jsx)(n.td,{children:"256Mi"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"API Watch Connections"}),(0,i.jsx)(n.td,{children:"1 per namespace"}),(0,i.jsx)(n.td,{children:"N namespaces"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Network"}),(0,i.jsx)(n.td,{children:"< 1 Kbps"}),(0,i.jsx)(n.td,{children:"< 5 Kbps"})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"performance",children:"Performance"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Event processing"}),": < 100ms per service"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Initial sync"}),": ~500ms per 100 services"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Max services"}),": 1000+ per namespace"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Restart time"}),": < 5 seconds"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Watch reconnect"}),": Automatic with exponential backoff"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"monitoring",children:"Monitoring"}),"\n",(0,i.jsx)(n.h3,{id:"key-metrics",children:"Key Metrics"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-promql",children:"# Services labeled\r\ndefog_services_labeled_total\r\n\r\n# Services skipped (already labeled or filtered)\r\ndefog_services_skipped_total\r\n\r\n# Errors encountered\r\ndefog_discovery_errors_total\r\n\r\n# Last reconciliation timestamp\r\ndefog_last_reconciliation_timestamp\n"})}),"\n",(0,i.jsx)(n.h3,{id:"health-checks",children:"Health Checks"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# Health endpoint\r\ncurl http://localhost:8080/health\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Response"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\r\n  "status": "healthy",\r\n  "version": "v2.0.0",\r\n  "lastReconciliation": "2024-01-15T10:30:00Z",\r\n  "servicesLabeled": 45,\r\n  "servicesSkipped": 12,\r\n  "errors": 0\r\n}\n'})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# Readiness endpoint\r\ncurl http://localhost:8080/ready\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Response (not ready)"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\r\n  "status": "not_ready",\r\n  "reason": "no recent reconciliation"\r\n}\n'})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# Statistics endpoint\r\ncurl http://localhost:8080/stats\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Response"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\r\n  "servicesLabeled": 45,\r\n  "servicesSkipped": 12,\r\n  "errors": 0,\r\n  "lastReconciliation": "2024-01-15T10:30:00Z",\r\n  "namespaces": ["default", "production", "staging"]\r\n}\n'})}),"\n",(0,i.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,i.jsx)(n.h3,{id:"issue-services-not-being-labeled",children:"Issue: Services Not Being Labeled"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Symptoms"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Services remain without export label"}),"\n",(0,i.jsx)(n.li,{children:"No log entries for the service"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Diagnosis"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'# Check controller is running\r\nkubectl get pods -n defog-system -l app=discovery-controller\r\n\r\n# Check logs with verbosity\r\nkubectl logs -n defog-system deployment/discovery-controller\r\n\r\n# Check if service is being watched\r\nkubectl logs -n defog-system deployment/discovery-controller | grep "service-name"\r\n\r\n# Verify RBAC permissions\r\nkubectl auth can-i update services --as=system:serviceaccount:defog-system:discovery-controller\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Common Causes"}),":"]}),"\n",(0,i.jsx)(n.mermaid,{value:"graph TD\r\n    A[Services Not Labeled] --\x3e B{Controller Running?}\r\n    B --\x3e|No| C[Check Pod Status]\r\n    B --\x3e|Yes| D{Namespace in Watch List?}\r\n    D --\x3e|No| E[Update NAMESPACES config]\r\n    D --\x3e|Yes| F{RBAC Permissions?}\r\n    F --\x3e|No| G[Apply ClusterRole/Binding]\r\n    F --\x3e|Yes| H{Service Filtered?}\r\n    H --\x3e|Yes| I[Check skip conditions]\r\n    H --\x3e|No| J{Watch Connection Active?}\r\n    J --\x3e|No| K[Check API server connectivity]\r\n    \r\n    style C fill:#ffe1e1\r\n    style E fill:#ffe1e1\r\n    style G fill:#ffe1e1\r\n    style I fill:#ffe1e1\r\n    style K fill:#ffe1e1"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Solutions"}),":"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Controller not running"}),":"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"kubectl rollout restart deployment/discovery-controller -n defog-system\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Namespace not watched"}),":"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'# Update ConfigMap\r\ndata:\r\n  NAMESPACES: "default,production,your-namespace"\n'})}),"\n",(0,i.jsxs)(n.ol,{start:"3",children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"RBAC issues"}),":"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"kubectl apply -f deployments/discovery-controller/rbac.yaml\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"4",children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Service is filtered"}),":"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'# Check if service matches skip conditions\r\nkubectl get service <name> -o yaml | grep -E "ClusterIP|annotations"\n'})}),"\n",(0,i.jsx)(n.h3,{id:"issue-watch-connection-lost",children:"Issue: Watch Connection Lost"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Symptoms"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:'Log shows "watch channel closed"'}),"\n",(0,i.jsx)(n.li,{children:"Services not being processed"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Cause"}),": The Kubernetes watch connection was interrupted"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Solution"}),": The controller automatically reconnects after 5 seconds. Check logs:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'kubectl logs -n defog-system deployment/discovery-controller | grep "restarting"\n'})}),"\n",(0,i.jsx)(n.h3,{id:"issue-event-emission-failures",children:"Issue: Event Emission Failures"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Symptoms"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Services are labeled but orchestrator doesn't receive events"}),"\n",(0,i.jsx)(n.li,{children:'Logs show "Failed to send event to orchestrator"'}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Diagnosis"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# Check orchestrator connectivity\r\nkubectl exec -n defog-system deployment/discovery-controller -- \\\r\n  wget -O- http://orchestrator:8080/health\r\n\r\n# Check if events are disabled\r\nkubectl get configmap discovery-controller-config -n defog-system -o yaml | grep ENABLE_EVENTS\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Solutions"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Verify orchestrator service is running"}),"\n",(0,i.jsx)(n.li,{children:"Check orchestrator URL in ConfigMap"}),"\n",(0,i.jsx)(n.li,{children:"Event emission failures don't block service labeling (async operation)"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"issue-high-memory-usage",children:"Issue: High Memory Usage"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Symptoms"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Memory usage exceeds 256Mi"}),"\n",(0,i.jsx)(n.li,{children:"OOMKilled pod restarts"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Causes"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Watching too many namespaces with many services"}),"\n",(0,i.jsx)(n.li,{children:"Large service objects"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Solutions"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'# Reduce watched namespaces\r\nNAMESPACES: "production"  # Only critical namespace\r\n\r\n# Or increase memory limits\r\nresources:\r\n  limits:\r\n    memory: 512Mi\n'})}),"\n",(0,i.jsx)(n.h2,{id:"advanced-configuration",children:"Advanced Configuration"}),"\n",(0,i.jsx)(n.h3,{id:"multiple-namespace-watching",children:"Multiple Namespace Watching"}),"\n",(0,i.jsx)(n.p,{children:"The controller can watch multiple namespaces simultaneously:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'data:\r\n  NAMESPACES: "default,production,staging,dev"\n'})}),"\n",(0,i.jsx)(n.p,{children:"Each namespace gets its own watch goroutine for isolation."}),"\n",(0,i.jsx)(n.h3,{id:"custom-export-labels",children:"Custom Export Labels"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'data:\r\n  EXPORT_LABEL: "custom.io/exported"\r\n  EXPORT_VALUE: "enabled"\n'})}),"\n",(0,i.jsx)(n.h3,{id:"skipping-individual-services",children:"Skipping Individual Services"}),"\n",(0,i.jsx)(n.p,{children:"Add annotation to any service:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'apiVersion: v1\r\nkind: Service\r\nmetadata:\r\n  name: internal-service\r\n  annotations:\r\n    defog.io/skip-export: "true"\r\nspec:\r\n  # ... service spec\n'})}),"\n",(0,i.jsx)(n.h3,{id:"adjusting-log-verbosity",children:"Adjusting Log Verbosity"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'data:\r\n  LOG_LEVEL: "0"  # Errors only\r\n  LOG_LEVEL: "1"  # + Warnings\r\n  LOG_LEVEL: "2"  # + Info (recommended)\r\n  LOG_LEVEL: "3"  # + Debug (verbose)\n'})}),"\n",(0,i.jsx)(n.h2,{id:"api-endpoints",children:"API Endpoints"}),"\n",(0,i.jsx)(n.h3,{id:"get-health",children:"GET /health"}),"\n",(0,i.jsx)(n.p,{children:"Health check endpoint."}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Response"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\r\n  "status": "healthy",\r\n  "version": "v2.0.0",\r\n  "lastReconciliation": "2024-01-15T10:30:00Z",\r\n  "servicesLabeled": 45,\r\n  "servicesSkipped": 12,\r\n  "errors": 0\r\n}\n'})}),"\n",(0,i.jsx)(n.h3,{id:"get-ready",children:"GET /ready"}),"\n",(0,i.jsx)(n.p,{children:"Readiness probe. Returns 503 if no reconciliation in last 5 minutes."}),"\n",(0,i.jsx)(n.h3,{id:"get-stats",children:"GET /stats"}),"\n",(0,i.jsx)(n.p,{children:"Detailed statistics about controller operation."}),"\n",(0,i.jsx)(n.h3,{id:"get-metrics",children:"GET /metrics"}),"\n",(0,i.jsx)(n.p,{children:"Prometheus metrics in text format:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"# HELP defog_services_labeled_total Total services labeled\r\n# TYPE defog_services_labeled_total counter\r\ndefog_services_labeled_total 45\r\n\r\n# HELP defog_services_skipped_total Total services skipped\r\n# TYPE defog_services_skipped_total counter\r\ndefog_services_skipped_total 12\r\n\r\n# HELP defog_discovery_errors_total Total errors\r\n# TYPE defog_discovery_errors_total counter\r\ndefog_discovery_errors_total 0\r\n\r\n# HELP defog_last_reconciliation_timestamp Last reconciliation timestamp\r\n# TYPE defog_last_reconciliation_timestamp gauge\r\ndefog_last_reconciliation_timestamp 1705315800\n"})}),"\n",(0,i.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,i.jsx)(n.h3,{id:"1-start-small",children:"1. Start Small"}),"\n",(0,i.jsx)(n.p,{children:"Begin with a single namespace:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'data:\r\n  NAMESPACES: "development"\n'})}),"\n",(0,i.jsx)(n.p,{children:"Then expand to production after validation."}),"\n",(0,i.jsx)(n.h3,{id:"2-use-single-replica",children:"2. Use Single Replica"}),"\n",(0,i.jsx)(n.p,{children:"The controller is designed to run as a single replica (replicas: 1). Multiple replicas would:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Cause redundant labeling operations"}),"\n",(0,i.jsx)(n.li,{children:"Increase API server load unnecessarily"}),"\n",(0,i.jsx)(n.li,{children:"Provide no additional benefit (stateless operation)"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"3-monitor-label-success",children:"3. Monitor Label Success"}),"\n",(0,i.jsx)(n.p,{children:"Set up alerts for labeling errors:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-promql",children:"rate(defog_discovery_errors_total[5m]) > 0\n"})}),"\n",(0,i.jsx)(n.h3,{id:"4-enable-verbose-logging-during-debugging",children:"4. Enable Verbose Logging During Debugging"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# Temporarily increase verbosity\r\nkubectl set env deployment/discovery-controller -n defog-system LOG_LEVEL=3\n"})}),"\n",(0,i.jsx)(n.h3,{id:"5-use-poddisruptionbudget",children:"5. Use PodDisruptionBudget"}),"\n",(0,i.jsx)(n.p,{children:"Prevent accidental downtime during cluster maintenance:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"apiVersion: policy/v1\r\nkind: PodDisruptionBudget\r\nmetadata:\r\n  name: discovery-controller\r\n  namespace: defog-system\r\nspec:\r\n  maxUnavailable: 0\r\n  selector:\r\n    matchLabels:\r\n      app: discovery-controller\n"})}),"\n",(0,i.jsx)(n.h2,{id:"integration-points",children:"Integration Points"}),"\n",(0,i.jsx)(n.h3,{id:"with-linkerd",children:"With Linkerd"}),"\n",(0,i.jsx)(n.p,{children:"The Discovery Controller prepares services for Linkerd multi-cluster:"}),"\n",(0,i.jsx)(n.mermaid,{value:"graph LR\r\n    A[Service Created] --\x3e B[K8s API Event]\r\n    B --\x3e C[Discovery Controller]\r\n    C --\x3e D[Add mirror.linkerd.io/exported]\r\n    D --\x3e E[Linkerd Detects Label]\r\n    E --\x3e F[Export to Gateway]\r\n    F --\x3e G[Mirrored in Peer Clusters]\r\n    \r\n    style C fill:#e1f5ff\r\n    style E fill:#e1ffe1"}),"\n",(0,i.jsx)(n.h3,{id:"with-orchestrator",children:"With Orchestrator"}),"\n",(0,i.jsx)(n.p,{children:"Events flow asynchronously to the Orchestrator:"}),"\n",(0,i.jsx)(n.mermaid,{value:"sequenceDiagram\r\n    participant SVC as Service\r\n    participant DC as Discovery Controller\r\n    participant ORCH as Orchestrator\r\n    \r\n    SVC->>DC: Service Created (K8s event)\r\n    DC->>SVC: Add export labels\r\n    DC--\x3e>ORCH: ServiceLabeledEvent (async)\r\n    ORCH->>ORCH: Register service for monitoring\r\n    Note over ORCH: Tracks RPS & stress metrics"}),"\n",(0,i.jsx)(n.p,{children:"Event emission is non-blocking with 5-second timeout."}),"\n",(0,i.jsx)(n.h2,{id:"source-code-reference",children:"Source Code Reference"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"cmd/discovery-controller/\r\n\u2514\u2500\u2500 main.go                 # Main application (all logic)\r\n\r\ndeployments/discovery-controller/\r\n\u251c\u2500\u2500 namespace.yaml          # defog-system namespace\r\n\u251c\u2500\u2500 rbac.yaml              # ServiceAccount, ClusterRole, ClusterRoleBinding\r\n\u251c\u2500\u2500 configmap.yaml         # Configuration\r\n\u251c\u2500\u2500 deployment.yaml        # Deployment spec\r\n\u251c\u2500\u2500 service.yaml           # ClusterIP service\r\n\u251c\u2500\u2500 servicemonitor.yaml    # Prometheus ServiceMonitor\r\n\u2514\u2500\u2500 poddisruptionbudget.yaml\n"})}),"\n",(0,i.jsx)(n.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"../architecture",children:"Architecture Overview"})," - How Discovery Controller fits"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"../services",children:"Service Details"})," - All 5 components"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"../deployment",children:"Deployment Guide"})," - Installation instructions"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"../troubleshooting",children:"Troubleshooting"})," - Common issues"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>t,x:()=>a});var s=r(6540);const i={},l=s.createContext(i);function t(e){const n=s.useContext(l);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:t(e.components),s.createElement(l.Provider,{value:n},e.children)}}}]);