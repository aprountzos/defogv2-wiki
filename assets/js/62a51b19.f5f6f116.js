"use strict";(globalThis.webpackChunkdefogv_2_wiki=globalThis.webpackChunkdefogv_2_wiki||[]).push([[1442],{6370:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>o,contentTitle:()=>c,default:()=>h,frontMatter:()=>l,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"architecture/components/scheduler","title":"Scheduler","description":"Pure decision logic for placement and eviction","source":"@site/docs/architecture/components/scheduler.mdx","sourceDirName":"architecture/components","slug":"/architecture/components/scheduler","permalink":"/defogv2-wiki/docs/architecture/components/scheduler","draft":false,"unlisted":false,"editUrl":"https://github.com/aprountzos/defogv2-wiki/tree/main/docs/docs/architecture/components/scheduler.mdx","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{"title":"Scheduler","description":"Pure decision logic for placement and eviction","sidebar_position":3},"sidebar":"tutorialSidebar","previous":{"title":"Metrics Monitor","permalink":"/defogv2-wiki/docs/architecture/components/metrics-monitor"},"next":{"title":"Orchestrator","permalink":"/defogv2-wiki/docs/architecture/components/orchestrator"}}');var i=n(4848),t=n(8453);const l={title:"Scheduler",description:"Pure decision logic for placement and eviction",sidebar_position:3},c="Scheduler",o={},a=[{value:"Overview",id:"overview",level:2},{value:"Purpose",id:"purpose",level:2},{value:"Key Characteristics",id:"key-characteristics",level:2},{value:"Stateless",id:"stateless",level:3},{value:"Side-Effect Free",id:"side-effect-free",level:3},{value:"Algorithms",id:"algorithms",level:2},{value:"1. Stress-Based Split Algorithm",id:"1-stress-based-split-algorithm",level:3},{value:"2. RPS-Based LFU Algorithm",id:"2-rps-based-lfu-algorithm",level:3},{value:"3. Weighted Scoring Algorithm",id:"3-weighted-scoring-algorithm",level:3},{value:"API Endpoints",id:"api-endpoints",level:2},{value:"POST /placement/decide",id:"post-placementdecide",level:3},{value:"POST /eviction/decide",id:"post-evictiondecide",level:3},{value:"POST /clusters/score",id:"post-clustersscore",level:3},{value:"Configuration",id:"configuration",level:2},{value:"Deployment",id:"deployment",level:2},{value:"Operational Characteristics",id:"operational-characteristics",level:2},{value:"Resource Usage",id:"resource-usage",level:3},{value:"Performance",id:"performance",level:3},{value:"Monitoring",id:"monitoring",level:2},{value:"Prometheus Metrics",id:"prometheus-metrics",level:3},{value:"Testing",id:"testing",level:2},{value:"Unit Test Example",id:"unit-test-example",level:3},{value:"Integration Test Example",id:"integration-test-example",level:3},{value:"Adding Custom Algorithms",id:"adding-custom-algorithms",level:2},{value:"1. Define Interface",id:"1-define-interface",level:3},{value:"2. Implement Algorithm",id:"2-implement-algorithm",level:3},{value:"3. Register Algorithm",id:"3-register-algorithm",level:3},{value:"4. Configure",id:"4-configure",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Issue: Wrong Decisions",id:"issue-wrong-decisions",level:3},{value:"Issue: Slow Response",id:"issue-slow-response",level:3},{value:"Source Code Reference",id:"source-code-reference",level:2},{value:"Related Documentation",id:"related-documentation",level:2}];function d(e){const r={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(r.header,{children:(0,i.jsx)(r.h1,{id:"scheduler",children:"Scheduler"})}),"\n",(0,i.jsxs)(r.p,{children:["The Scheduler is a ",(0,i.jsx)(r.strong,{children:"stateless decision engine"})," that implements pluggable algorithms for service placement, eviction, and cluster scoring. It has no side effects\u2014it only returns decisions based on inputs."]}),"\n",(0,i.jsx)(r.h2,{id:"overview",children:"Overview"}),"\n",(0,i.jsx)(r.mermaid,{value:"graph TB\r\n    ORCH[Orchestrator] --\x3e|PlacementRequest| SCHED[Scheduler]\r\n    SCHED --\x3e SA[Stress Algorithm]\r\n    SCHED --\x3e LFU[RPS-LFU Algorithm]\r\n    SCHED --\x3e WS[Weighted Scoring]\r\n    \r\n    SA --\x3e|Traffic Split %| ORCH\r\n    LFU --\x3e|Eviction Decision| ORCH\r\n    WS --\x3e|Cluster Score| ORCH\r\n    \r\n    style SCHED fill:#fff4e1\r\n    style SA fill:#ffe1e1\r\n    style LFU fill:#e1ffe1\r\n    style WS fill:#e1f5ff"}),"\n",(0,i.jsx)(r.h2,{id:"purpose",children:"Purpose"}),"\n",(0,i.jsxs)(r.p,{children:["The Scheduler provides ",(0,i.jsx)(r.strong,{children:"pure business logic"})," without side effects:"]}),"\n",(0,i.jsxs)(r.ol,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Stress-Based Splitting"})," - Calculate traffic split percentages"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"RPS-Based LFU"})," - Determine which services to evict"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Cluster Scoring"})," - Rank peer clusters for placement"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Placement Decisions"})," - Decide where to deploy services"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Pluggable Algorithms"})," - Easy to add new strategies"]}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"key-characteristics",children:"Key Characteristics"}),"\n",(0,i.jsx)(r.h3,{id:"stateless",children:"Stateless"}),"\n",(0,i.jsx)(r.mermaid,{value:"graph LR\r\n    A[Input:<br/>PlacementRequest] --\x3e B[Scheduler<br/>Pure Function]\r\n    B --\x3e C[Output:<br/>PlacementDecision]\r\n    \r\n    style B fill:#fff4e1"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"No internal state"}),"\n",(0,i.jsx)(r.li,{children:"No database or cache"}),"\n",(0,i.jsx)(r.li,{children:"Same input = same output"}),"\n",(0,i.jsx)(r.li,{children:"Easy to test and reason about"}),"\n"]}),"\n",(0,i.jsx)(r.h3,{id:"side-effect-free",children:"Side-Effect Free"}),"\n",(0,i.jsxs)(r.p,{children:["The Scheduler ",(0,i.jsx)(r.strong,{children:"never"}),":"]}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"Makes API calls"}),"\n",(0,i.jsx)(r.li,{children:"Modifies resources"}),"\n",(0,i.jsx)(r.li,{children:"Stores data"}),"\n",(0,i.jsx)(r.li,{children:"Emits events"}),"\n"]}),"\n",(0,i.jsxs)(r.p,{children:["It ",(0,i.jsx)(r.strong,{children:"only"}),":"]}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"Receives requests"}),"\n",(0,i.jsx)(r.li,{children:"Runs algorithms"}),"\n",(0,i.jsx)(r.li,{children:"Returns decisions"}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"algorithms",children:"Algorithms"}),"\n",(0,i.jsx)(r.h3,{id:"1-stress-based-split-algorithm",children:"1. Stress-Based Split Algorithm"}),"\n",(0,i.jsx)(r.p,{children:"Calculates traffic split based on pod stress level."}),"\n",(0,i.jsx)(r.mermaid,{value:"graph TD\r\n    A[Input: Stress 0.85] --\x3e B{Stress Value}\r\n    B --\x3e|< 0.70| C[0% to Mirror]\r\n    B --\x3e|0.70 - 0.80| D[10% to Mirror]\r\n    B --\x3e|0.80 - 0.90| E[30% to Mirror]\r\n    B --\x3e|\u2265 0.90| F[50% to Mirror]\r\n    \r\n    C --\x3e G[PlacementDecision]\r\n    D --\x3e G\r\n    E --\x3e G\r\n    F --\x3e G\r\n    \r\n    style G fill:#e1ffe1"}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Implementation"}),":"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-go",children:"type StressBasedSplitAlgorithm struct {\r\n    thresholds map[string]float64\r\n}\r\n\r\nfunc (a *StressBasedSplitAlgorithm) CalculateSplit(stress float64) int {\r\n    if stress < 0.70 {\r\n        return 0  // 0% to mirror\r\n    } else if stress < 0.80 {\r\n        return 10  // 10% to mirror\r\n    } else if stress < 0.90 {\r\n        return 30  // 30% to mirror\r\n    } else {\r\n        return 50  // 50% to mirror\r\n    }\r\n}\n"})}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Example"}),":"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-json",children:'// Input\r\n{\r\n  "serviceName": "api",\r\n  "currentStress": 0.85\r\n}\r\n\r\n// Output\r\n{\r\n  "action": "shift_traffic",\r\n  "mirrorPercent": 30,\r\n  "localPercent": 70,\r\n  "reason": "stress between 0.80 and 0.90"\r\n}\n'})}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h3,{id:"2-rps-based-lfu-algorithm",children:"2. RPS-Based LFU Algorithm"}),"\n",(0,i.jsx)(r.p,{children:"Determines which service to evict based on RPS (Least Frequently Used)."}),"\n",(0,i.jsx)(r.mermaid,{value:"graph TD\r\n    A[Input: Services + RPS] --\x3e B[Filter Local Services]\r\n    B --\x3e C[Sort by RPS Ascending]\r\n    C --\x3e D[Get Lowest RPS Service]\r\n    D --\x3e E{RPS < MinRPSToKeep?}\r\n    E --\x3e|Yes| F[Can Evict:<br/>service-x RPS=8]\r\n    E --\x3e|No| G[Cannot Evict:<br/>All above threshold]\r\n    \r\n    F --\x3e H[EvictionDecision]\r\n    G --\x3e H\r\n    \r\n    style F fill:#e1ffe1\r\n    style G fill:#ffcccc"}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Implementation"}),":"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-go",children:'type RPSBasedLFU struct {\r\n    minRPSToKeep float64\r\n}\r\n\r\nfunc (l *RPSBasedLFU) DecideEviction(req EvictionRequest) EvictionDecision {\r\n    // Filter only local services\r\n    var localServices []ServiceRPSMetrics\r\n    for _, svc := range req.CurrentServices {\r\n        if svc.IsLocal {\r\n            localServices = append(localServices, svc)\r\n        }\r\n    }\r\n    \r\n    if len(localServices) == 0 {\r\n        return EvictionDecision{\r\n            CanMakeSpace: false,\r\n            Reason:       "no local services to evict",\r\n        }\r\n    }\r\n    \r\n    // Sort by RPS (ascending - lowest first)\r\n    sort.Slice(localServices, func(i, j int) bool {\r\n        return localServices[i].CurrentRPS < localServices[j].CurrentRPS\r\n    })\r\n    \r\n    // Check if lowest RPS service is below minRPSToKeep\r\n    lowestRPS := localServices[0].CurrentRPS\r\n    \r\n    if lowestRPS >= l.minRPSToKeep {\r\n        return EvictionDecision{\r\n            CanMakeSpace: false,\r\n            Reason:       "all services above minRPSToKeep threshold",\r\n            LowestRPS:    lowestRPS,\r\n        }\r\n    }\r\n    \r\n    return EvictionDecision{\r\n        CanMakeSpace:     true,\r\n        ServicesToDelete: []string{localServices[0].ServiceName},\r\n        Reason:           "service has low RPS and below threshold",\r\n        LowestRPS:        lowestRPS,\r\n    }\r\n}\n'})}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Example"}),":"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-json",children:'// Input\r\n{\r\n  "currentServices": [\r\n    {"serviceName": "api", "isLocal": true, "currentRps": 450},\r\n    {"serviceName": "payments", "isLocal": true, "currentRps": 320},\r\n    {"serviceName": "old-api", "isLocal": true, "currentRps": 8},\r\n    {"serviceName": "reports", "isLocal": true, "currentRps": 150}\r\n  ],\r\n  "minRpsToKeep": 50.0\r\n}\r\n\r\n// Output\r\n{\r\n  "canMakeSpace": true,\r\n  "servicesToDelete": ["old-api"],\r\n  "reason": "service has low RPS (8) and below threshold (50)",\r\n  "lowestRps": 8.0\r\n}\n'})}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h3,{id:"3-weighted-scoring-algorithm",children:"3. Weighted Scoring Algorithm"}),"\n",(0,i.jsx)(r.p,{children:"Scores peer clusters for placement decisions."}),"\n",(0,i.jsx)(r.mermaid,{value:"graph TD\r\n    A[Input: Cluster Info] --\x3e B[Score CPU Capacity<br/>40% weight]\r\n    A --\x3e C[Score Memory<br/>40% weight]\r\n    A --\x3e D[Score Latency<br/>20% weight]\r\n    \r\n    B --\x3e E[Weighted Sum]\r\n    C --\x3e E\r\n    D --\x3e E\r\n    \r\n    E --\x3e F[Final Score<br/>0.0 - 1.0]\r\n    \r\n    style F fill:#e1f5ff"}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Scoring Formula"}),":"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:"Score = (CPU_Score * 0.4) + (Memory_Score * 0.4) + (Latency_Score * 0.2)\r\n\r\nCPU_Score = FreeCPU / TotalCPU\r\nMemory_Score = FreeMemory / TotalMemory\r\n\r\nLatency_Score:\r\n  < 10ms   \u2192 1.0\r\n  < 50ms   \u2192 0.8\r\n  < 100ms  \u2192 0.5\r\n  >= 100ms \u2192 0.2\n"})}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Implementation"}),":"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-go",children:"type WeightedScoringAlgorithm struct {\r\n    cpuWeight     float64\r\n    memoryWeight  float64\r\n    latencyWeight float64\r\n}\r\n\r\nfunc (a *WeightedScoringAlgorithm) ScoreCluster(cluster ClusterInfo) float64 {\r\n    // Calculate CPU score\r\n    cpuScore := cluster.Capacity.FreeCPU / cluster.Capacity.TotalCPU\r\n    \r\n    // Calculate memory score\r\n    memScore := cluster.Capacity.FreeMemory / cluster.Capacity.TotalMemory\r\n    \r\n    // Calculate latency score\r\n    latencyScore := 1.0\r\n    if cluster.Latency != nil {\r\n        latencyMs := float64(cluster.Latency.Milliseconds())\r\n        if latencyMs < 10 {\r\n            latencyScore = 1.0\r\n        } else if latencyMs < 50 {\r\n            latencyScore = 0.8\r\n        } else if latencyMs < 100 {\r\n            latencyScore = 0.5\r\n        } else {\r\n            latencyScore = 0.2\r\n        }\r\n    }\r\n    \r\n    // Weighted sum\r\n    return (cpuScore * a.cpuWeight) +\r\n           (memScore * a.memoryWeight) +\r\n           (latencyScore * a.latencyWeight)\r\n}\n"})}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Example"}),":"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-json",children:'// Input\r\n{\r\n  "clusters": [\r\n    {\r\n      "clusterId": "cluster-b",\r\n      "capacity": {\r\n        "freeCpu": 4.5,\r\n        "totalCpu": 8.0,\r\n        "freeMemory": 8.0,\r\n        "totalMemory": 16.0\r\n      },\r\n      "latency": 15000000  // 15ms\r\n    },\r\n    {\r\n      "clusterId": "cluster-c",\r\n      "capacity": {\r\n        "freeCpu": 2.0,\r\n        "totalCpu": 8.0,\r\n        "freeMemory": 10.0,\r\n        "totalMemory": 16.0\r\n      },\r\n      "latency": 80000000  // 80ms\r\n    }\r\n  ]\r\n}\r\n\r\n// Output\r\n{\r\n  "scores": {\r\n    "cluster-b": 0.84,  // High score (good capacity + low latency)\r\n    "cluster-c": 0.56   // Lower score (less CPU + higher latency)\r\n  },\r\n  "recommended": "cluster-b"\r\n}\n'})}),"\n",(0,i.jsx)(r.h2,{id:"api-endpoints",children:"API Endpoints"}),"\n",(0,i.jsx)(r.h3,{id:"post-placementdecide",children:"POST /placement/decide"}),"\n",(0,i.jsx)(r.p,{children:"Get placement decision for a service."}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Request"}),":"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-json",children:'{\r\n  "serviceName": "payments",\r\n  "namespace": "default",\r\n  "resources": {\r\n    "cpuRequest": "500m",\r\n    "memoryRequest": "512Mi"\r\n  },\r\n  "currentStress": 0.85,\r\n  "availableClusters": [\r\n    {\r\n      "clusterId": "cluster-b",\r\n      "capacity": {\r\n        "freeCpu": 4.5,\r\n        "freeMemory": 8.0\r\n      },\r\n      "healthy": true\r\n    }\r\n  ]\r\n}\n'})}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Response"}),":"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-json",children:'{\r\n  "action": "deploy_remote",\r\n  "targetCluster": "cluster-b",\r\n  "reason": "local stress high, peer has capacity",\r\n  "recommendedReplicas": 2\r\n}\n'})}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Action Values"}),":"]}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"deploy_local"})," - Deploy on local cluster"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"deploy_remote"})," - Deploy on peer cluster"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"scale_local"})," - Scale existing local deployment"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"no_action"})," - Do nothing"]}),"\n"]}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h3,{id:"post-evictiondecide",children:"POST /eviction/decide"}),"\n",(0,i.jsx)(r.p,{children:"Get eviction decision based on LFU."}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Request"}),":"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-json",children:'{\r\n  "currentServices": [\r\n    {\r\n      "serviceName": "api",\r\n      "isLocal": true,\r\n      "currentRps": 450.0\r\n    },\r\n    {\r\n      "serviceName": "old-api",\r\n      "isLocal": true,\r\n      "currentRps": 8.0\r\n    }\r\n  ],\r\n  "requiredSpace": {\r\n    "cpuRequest": "500m",\r\n    "memoryRequest": "512Mi"\r\n  },\r\n  "minRpsToKeep": 50.0\r\n}\n'})}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Response"}),":"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-json",children:'{\r\n  "canMakeSpace": true,\r\n  "servicesToDelete": ["old-api"],\r\n  "reason": "service has low RPS (8) below threshold (50)",\r\n  "lowestRps": 8.0,\r\n  "algorithmUsed": "lfu"\r\n}\n'})}),"\n",(0,i.jsx)(r.hr,{}),"\n",(0,i.jsx)(r.h3,{id:"post-clustersscore",children:"POST /clusters/score"}),"\n",(0,i.jsx)(r.p,{children:"Score peer clusters for placement."}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Request"}),":"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-json",children:'{\r\n  "clusters": [\r\n    {\r\n      "clusterId": "cluster-b",\r\n      "capacity": {\r\n        "freeCpu": 4.5,\r\n        "freeMemory": 8.0,\r\n        "totalCpu": 8.0,\r\n        "totalMemory": 16.0\r\n      },\r\n      "latency": 15000000\r\n    }\r\n  ],\r\n  "weights": {\r\n    "cpu": 0.4,\r\n    "memory": 0.4,\r\n    "latency": 0.2\r\n  }\r\n}\n'})}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Response"}),":"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-json",children:'{\r\n  "scores": {\r\n    "cluster-b": {\r\n      "totalScore": 0.84,\r\n      "cpuScore": 0.56,\r\n      "memoryScore": 0.50,\r\n      "latencyScore": 0.8\r\n    }\r\n  },\r\n  "recommended": "cluster-b"\r\n}\n'})}),"\n",(0,i.jsx)(r.h2,{id:"configuration",children:"Configuration"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-yaml",children:'apiVersion: v1\r\nkind: ConfigMap\r\nmetadata:\r\n  name: defog-config\r\n  namespace: defog-system\r\ndata:\r\n  # Algorithm selection\r\n  EVICTION_ALGORITHM: "lfu"  # lfu, lru, or custom\r\n  PLACEMENT_ALGORITHM: "weighted"  # simple, weighted, or custom\r\n  \r\n  # LFU settings\r\n  MIN_RPS_TO_KEEP: "50.0"\r\n  \r\n  # Stress thresholds\r\n  STRESS_HIGH: "0.80"\r\n  STRESS_CRITICAL: "0.90"\r\n  \r\n  # Scoring weights\r\n  CPU_WEIGHT: "0.4"\r\n  MEMORY_WEIGHT: "0.4"\r\n  LATENCY_WEIGHT: "0.2"\n'})}),"\n",(0,i.jsx)(r.h2,{id:"deployment",children:"Deployment"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-yaml",children:"apiVersion: apps/v1\r\nkind: Deployment\r\nmetadata:\r\n  name: scheduler\r\n  namespace: defog-system\r\nspec:\r\n  replicas: 1\r\n  selector:\r\n    matchLabels:\r\n      app: scheduler\r\n  template:\r\n    metadata:\r\n      labels:\r\n        app: scheduler\r\n    spec:\r\n      containers:\r\n      - name: scheduler\r\n        image: registry.io/defog-scheduler:v2.0.0\r\n        ports:\r\n        - containerPort: 8080\r\n          name: http\r\n        envFrom:\r\n        - configMapRef:\r\n            name: defog-config\r\n        resources:\r\n          requests:\r\n            cpu: 100m\r\n            memory: 128Mi\r\n          limits:\r\n            cpu: 300m\r\n            memory: 256Mi\r\n        livenessProbe:\r\n          httpGet:\r\n            path: /health\r\n            port: 8080\r\n        readinessProbe:\r\n          httpGet:\r\n            path: /health\r\n            port: 8080\r\n---\r\napiVersion: v1\r\nkind: Service\r\nmetadata:\r\n  name: scheduler\r\n  namespace: defog-system\r\nspec:\r\n  selector:\r\n    app: scheduler\r\n  ports:\r\n  - port: 8080\r\n    targetPort: 8080\n"})}),"\n",(0,i.jsx)(r.h2,{id:"operational-characteristics",children:"Operational Characteristics"}),"\n",(0,i.jsx)(r.h3,{id:"resource-usage",children:"Resource Usage"}),"\n",(0,i.jsxs)(r.table,{children:[(0,i.jsx)(r.thead,{children:(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.th,{children:"Metric"}),(0,i.jsx)(r.th,{children:"Value"})]})}),(0,i.jsxs)(r.tbody,{children:[(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"CPU"}),(0,i.jsx)(r.td,{children:"50-100m (avg), 300m (max)"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"Memory"}),(0,i.jsx)(r.td,{children:"100-128Mi (stable)"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"Response Time"}),(0,i.jsx)(r.td,{children:"< 10ms (p95)"})]}),(0,i.jsxs)(r.tr,{children:[(0,i.jsx)(r.td,{children:"Throughput"}),(0,i.jsx)(r.td,{children:"1000+ req/s"})]})]})]}),"\n",(0,i.jsx)(r.h3,{id:"performance",children:"Performance"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Stateless"})," - Can scale horizontally"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Fast"})," - Pure computation, no I/O"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Deterministic"})," - Same input = same output"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Testable"})," - Easy unit tests"]}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"monitoring",children:"Monitoring"}),"\n",(0,i.jsx)(r.h3,{id:"prometheus-metrics",children:"Prometheus Metrics"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-promql",children:'# Decision latency\r\nhistogram_quantile(0.95, defog_scheduler_decision_duration_seconds)\r\n\r\n# Decisions by type\r\nrate(defog_scheduler_decisions_total{action="deploy_remote"}[5m])\r\n\r\n# Eviction decisions\r\nrate(defog_scheduler_evictions_total[5m])\r\n\r\n# Algorithm usage\r\ndefog_scheduler_algorithm_used{algorithm="lfu"}\n'})}),"\n",(0,i.jsx)(r.h2,{id:"testing",children:"Testing"}),"\n",(0,i.jsx)(r.h3,{id:"unit-test-example",children:"Unit Test Example"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-go",children:'func TestLFUEviction(t *testing.T) {\r\n    lfu := NewRPSBasedLFU(50.0)  // minRPSToKeep\r\n    \r\n    req := EvictionRequest{\r\n        CurrentServices: []ServiceRPSMetrics{\r\n            {ServiceName: "api", IsLocal: true, CurrentRPS: 450},\r\n            {ServiceName: "old-api", IsLocal: true, CurrentRPS: 8},\r\n            {ServiceName: "payments", IsLocal: true, CurrentRPS: 320},\r\n        },\r\n        MinRPSToKeep: 50.0,\r\n    }\r\n    \r\n    decision := lfu.DecideEviction(req)\r\n    \r\n    assert.True(t, decision.CanMakeSpace)\r\n    assert.Equal(t, []string{"old-api"}, decision.ServicesToDelete)\r\n    assert.Equal(t, 8.0, decision.LowestRPS)\r\n}\n'})}),"\n",(0,i.jsx)(r.h3,{id:"integration-test-example",children:"Integration Test Example"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-go",children:'func TestPlacementDecision(t *testing.T) {\r\n    // Setup\r\n    scheduler := NewScheduler(config)\r\n    \r\n    // Test stress-based placement\r\n    req := PlacementRequest{\r\n        ServiceName:   "api",\r\n        CurrentStress: 0.85,\r\n        AvailableClusters: []ClusterInfo{\r\n            {ClusterID: "cluster-b", Healthy: true},\r\n        },\r\n    }\r\n    \r\n    decision := scheduler.DecidePlacement(req)\r\n    \r\n    assert.Equal(t, "deploy_remote", decision.Action)\r\n    assert.Equal(t, "cluster-b", decision.TargetCluster)\r\n}\n'})}),"\n",(0,i.jsx)(r.h2,{id:"adding-custom-algorithms",children:"Adding Custom Algorithms"}),"\n",(0,i.jsx)(r.h3,{id:"1-define-interface",children:"1. Define Interface"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-go",children:"type PlacementAlgorithm interface {\r\n    Decide(ctx context.Context, req PlacementRequest) PlacementDecision\r\n}\n"})}),"\n",(0,i.jsx)(r.h3,{id:"2-implement-algorithm",children:"2. Implement Algorithm"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-go",children:'type CostBasedAlgorithm struct {\r\n    costPerCPUHour float64\r\n}\r\n\r\nfunc (a *CostBasedAlgorithm) Decide(ctx context.Context, req PlacementRequest) PlacementDecision {\r\n    // Find cheapest cluster with capacity\r\n    var cheapest ClusterInfo\r\n    minCost := math.MaxFloat64\r\n    \r\n    for _, cluster := range req.AvailableClusters {\r\n        cost := a.calculateCost(cluster)\r\n        if cost < minCost && cluster.Capacity.FreeCPU > 1.0 {\r\n            minCost = cost\r\n            cheapest = cluster\r\n        }\r\n    }\r\n    \r\n    return PlacementDecision{\r\n        Action:        "deploy_remote",\r\n        TargetCluster: cheapest.ClusterID,\r\n        Reason:        fmt.Sprintf("lowest cost: $%.2f/hour", minCost),\r\n    }\r\n}\n'})}),"\n",(0,i.jsx)(r.h3,{id:"3-register-algorithm",children:"3. Register Algorithm"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-go",children:'scheduler.RegisterAlgorithm("cost", &CostBasedAlgorithm{\r\n    costPerCPUHour: 0.05,\r\n})\n'})}),"\n",(0,i.jsx)(r.h3,{id:"4-configure",children:"4. Configure"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-yaml",children:'PLACEMENT_ALGORITHM: "cost"\r\nCOST_PER_CPU_HOUR: "0.05"\n'})}),"\n",(0,i.jsx)(r.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,i.jsxs)(r.ol,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Keep algorithms pure"})," - No side effects"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Make decisions deterministic"})," - Same input = same output"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Log all decisions"})," - For debugging and auditing"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Test thoroughly"})," - Unit test each algorithm"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Document thresholds"})," - Explain why values chosen"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.strong,{children:"Make pluggable"})," - Easy to swap algorithms"]}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,i.jsx)(r.h3,{id:"issue-wrong-decisions",children:"Issue: Wrong Decisions"}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Check algorithm logic"}),":"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-bash",children:'# Enable debug logging\r\nkubectl set env deployment/scheduler LOG_LEVEL=debug -n defog-system\r\n\r\n# Check decision logs\r\nkubectl logs -n defog-system deployment/scheduler | grep "Decision"\n'})}),"\n",(0,i.jsx)(r.h3,{id:"issue-slow-response",children:"Issue: Slow Response"}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Check CPU usage"}),":"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-bash",children:"kubectl top pod -n defog-system -l app=scheduler\n"})}),"\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Scale if needed"}),":"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-bash",children:"kubectl scale deployment/scheduler --replicas=3 -n defog-system\n"})}),"\n",(0,i.jsx)(r.h2,{id:"source-code-reference",children:"Source Code Reference"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:"internal/scheduler/\r\n\u251c\u2500\u2500 server.go          # HTTP server\r\n\u251c\u2500\u2500 algorithms.go      # Algorithm implementations\r\n\u251c\u2500\u2500 lfu.go             # LFU algorithm\r\n\u251c\u2500\u2500 scoring.go         # Cluster scoring\r\n\u2514\u2500\u2500 interface.go       # Algorithm interface\r\n\r\npkg/api/\r\n\u2514\u2500\u2500 types.go           # Request/response types\n"})}),"\n",(0,i.jsx)(r.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.a,{href:"../dual-strategy",children:"Dual-Strategy Design"})," - How algorithms are used"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.a,{href:"./orchestrator",children:"Orchestrator"})," - Decision consumer"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.a,{href:"../configuration",children:"Configuration Guide"})," - Algorithm tuning"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.a,{href:"../api",children:"API Reference"})," - Complete API specs"]}),"\n"]})]})}function h(e={}){const{wrapper:r}={...(0,t.R)(),...e.components};return r?(0,i.jsx)(r,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,r,n)=>{n.d(r,{R:()=>l,x:()=>c});var s=n(6540);const i={},t=s.createContext(i);function l(e){const r=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function c(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),s.createElement(t.Provider,{value:r},e.children)}}}]);