"use strict";(globalThis.webpackChunkdefogv_2_wiki=globalThis.webpackChunkdefogv_2_wiki||[]).push([[1275],{1470:(e,r,n)=>{n.d(r,{A:()=>w});var s=n(6540),l=n(4164),i=n(7559),t=n(3104),a=n(6347),o=n(205),c=n(7485),d=n(1682),u=n(679);function h(e){return s.Children.toArray(e).filter(e=>"\n"!==e).map(e=>{if(!e||(0,s.isValidElement)(e)&&function(e){const{props:r}=e;return!!r&&"object"==typeof r&&"value"in r}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})?.filter(Boolean)??[]}function p(e){const{values:r,children:n}=e;return(0,s.useMemo)(()=>{const e=r??function(e){return h(e).map(({props:{value:e,label:r,attributes:n,default:s}})=>({value:e,label:r,attributes:n,default:s}))}(n);return function(e){const r=(0,d.XI)(e,(e,r)=>e.value===r.value);if(r.length>0)throw new Error(`Docusaurus error: Duplicate values "${r.map(e=>e.value).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e},[r,n])}function x({value:e,tabValues:r}){return r.some(r=>r.value===e)}function v({queryString:e=!1,groupId:r}){const n=(0,a.W6)(),l=function({queryString:e=!1,groupId:r}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!r)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return r??null}({queryString:e,groupId:r});return[(0,c.aZ)(l),(0,s.useCallback)(e=>{if(!l)return;const r=new URLSearchParams(n.location.search);r.set(l,e),n.replace({...n.location,search:r.toString()})},[l,n])]}function m(e){const{defaultValue:r,queryString:n=!1,groupId:l}=e,i=p(e),[t,a]=(0,s.useState)(()=>function({defaultValue:e,tabValues:r}){if(0===r.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!x({value:e,tabValues:r}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${r.map(e=>e.value).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}const n=r.find(e=>e.default)??r[0];if(!n)throw new Error("Unexpected error: 0 tabValues");return n.value}({defaultValue:r,tabValues:i})),[c,d]=v({queryString:n,groupId:l}),[h,m]=function({groupId:e}){const r=function(e){return e?`docusaurus.tab.${e}`:null}(e),[n,l]=(0,u.Dv)(r);return[n,(0,s.useCallback)(e=>{r&&l.set(e)},[r,l])]}({groupId:l}),g=(()=>{const e=c??h;return x({value:e,tabValues:i})?e:null})();(0,o.A)(()=>{g&&a(g)},[g]);return{selectedValue:t,selectValue:(0,s.useCallback)(e=>{if(!x({value:e,tabValues:i}))throw new Error(`Can't select invalid tab value=${e}`);a(e),d(e),m(e)},[d,m,i]),tabValues:i}}var g=n(2303);const j={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var b=n(4848);function f({className:e,block:r,selectedValue:n,selectValue:s,tabValues:i}){const a=[],{blockElementScrollPositionUntilNextRender:o}=(0,t.a_)(),c=e=>{const r=e.currentTarget,l=a.indexOf(r),t=i[l].value;t!==n&&(o(r),s(t))},d=e=>{let r=null;switch(e.key){case"Enter":c(e);break;case"ArrowRight":{const n=a.indexOf(e.currentTarget)+1;r=a[n]??a[0];break}case"ArrowLeft":{const n=a.indexOf(e.currentTarget)-1;r=a[n]??a[a.length-1];break}}r?.focus()};return(0,b.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,l.A)("tabs",{"tabs--block":r},e),children:i.map(({value:e,label:r,attributes:s})=>(0,b.jsx)("li",{role:"tab",tabIndex:n===e?0:-1,"aria-selected":n===e,ref:e=>{a.push(e)},onKeyDown:d,onClick:c,...s,className:(0,l.A)("tabs__item",j.tabItem,s?.className,{"tabs__item--active":n===e}),children:r??e},e))})}function y({lazy:e,children:r,selectedValue:n}){const i=(Array.isArray(r)?r:[r]).filter(Boolean);if(e){const e=i.find(e=>e.props.value===n);return e?(0,s.cloneElement)(e,{className:(0,l.A)("margin-top--md",e.props.className)}):null}return(0,b.jsx)("div",{className:"margin-top--md",children:i.map((e,r)=>(0,s.cloneElement)(e,{key:r,hidden:e.props.value!==n}))})}function k(e){const r=m(e);return(0,b.jsxs)("div",{className:(0,l.A)(i.G.tabs.container,"tabs-container",j.tabList),children:[(0,b.jsx)(f,{...r,...e}),(0,b.jsx)(y,{...r,...e})]})}function w(e){const r=(0,g.A)();return(0,b.jsx)(k,{...e,children:h(e.children)},String(r))}},2022:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>d,contentTitle:()=>c,default:()=>p,frontMatter:()=>o,metadata:()=>s,toc:()=>u});const s=JSON.parse('{"id":"service-auto-exporter","title":"Service Auto-Exporter Controller","description":"Automatically add export labels to Kubernetes Services for multicluster and service mesh scenarios","source":"@site/docs/service-auto-exporter.mdx","sourceDirName":".","slug":"/service-auto-exporter","permalink":"/defogv2-wiki/docs/service-auto-exporter","draft":false,"unlisted":false,"editUrl":"https://github.com/aprountzos/defogv2-wiki/tree/main/docs/docs/service-auto-exporter.mdx","tags":[],"version":"current","sidebarPosition":1,"frontMatter":{"title":"Service Auto-Exporter Controller","description":"Automatically add export labels to Kubernetes Services for multicluster and service mesh scenarios","sidebar_position":1},"sidebar":"tutorialSidebar","previous":{"title":"K3s & K3d","permalink":"/defogv2-wiki/docs/k3s-k3d"},"next":{"title":"Cloud-Fog-Edge Architecture","permalink":"/defogv2-wiki/docs/cloud-fog-edge"}}');var l=n(4848),i=n(8453),t=n(1470),a=n(9365);const o={title:"Service Auto-Exporter Controller",description:"Automatically add export labels to Kubernetes Services for multicluster and service mesh scenarios",sidebar_position:1},c="Service Auto-Exporter Controller",d={},u=[{value:"Overview",id:"overview",level:2},{value:"How It Works",id:"how-it-works",level:2},{value:"Workflow Details",id:"workflow-details",level:3},{value:"Configuration",id:"configuration",level:2},{value:"Command-Line Flags",id:"command-line-flags",level:3},{value:"Example Usage",id:"example-usage",level:3},{value:"Deployment",id:"deployment",level:2},{value:"Kubernetes Deployment",id:"kubernetes-deployment",level:3},{value:"Apply the Deployment",id:"apply-the-deployment",level:3},{value:"Verify Deployment",id:"verify-deployment",level:3},{value:"Behavior &amp; Features",id:"behavior--features",level:2},{value:"\u2705 Processes Existing Services",id:"-processes-existing-services",level:3},{value:"\u2705 Watches for New/Updated Services",id:"-watches-for-newupdated-services",level:3},{value:"\u2705 Skips System Services",id:"-skips-system-services",level:3},{value:"\u2705 Safe Updates",id:"-safe-updates",level:3},{value:"Use Cases",id:"use-cases",level:2},{value:"Example Behavior",id:"example-behavior",level:2},{value:"Architecture",id:"architecture",level:2},{value:"Code Structure",id:"code-structure",level:3},{value:"Config",id:"config",level:4},{value:"Controller",id:"controller",level:4},{value:"Key Methods",id:"key-methods",level:4},{value:"Logging",id:"logging",level:2},{value:"Log Levels",id:"log-levels",level:3},{value:"Example Log Output",id:"example-log-output",level:3},{value:"Development",id:"development",level:2},{value:"Building from Source",id:"building-from-source",level:3},{value:"Running Locally",id:"running-locally",level:3},{value:"Testing",id:"testing",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Controller not starting",id:"controller-not-starting",level:3},{value:"Services not being labeled",id:"services-not-being-labeled",level:3},{value:"Permission errors",id:"permission-errors",level:3},{value:"FAQ",id:"faq",level:2},{value:"Contributing",id:"contributing",level:2},{value:"License",id:"license",level:2}];function h(e){const r={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components},{Details:n}=r;return n||function(e,r){throw new Error("Expected "+(r?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(r.header,{children:(0,l.jsx)(r.h1,{id:"service-auto-exporter-controller",children:"Service Auto-Exporter Controller"})}),"\n",(0,l.jsx)(r.admonition,{title:"Quick Start",type:"tip",children:(0,l.jsxs)(r.p,{children:["Deploy in 2 minutes with our ",(0,l.jsx)(r.a,{href:"#kubernetes-deployment",children:"complete Kubernetes deployment"})," manifest."]})}),"\n",(0,l.jsxs)(r.p,{children:["The ",(0,l.jsx)(r.strong,{children:"Service Auto-Exporter"})," is a lightweight Kubernetes controller that automatically adds specific labels to all Services within a target namespace. It's designed primarily to support systems like ",(0,l.jsx)(r.strong,{children:"Linkerd multicluster mirroring"}),", where services require specific export labels (e.g., ",(0,l.jsx)(r.code,{children:"mirror.linkerd.io/exported=true"}),")."]}),"\n",(0,l.jsx)(r.h2,{id:"overview",children:"Overview"}),"\n",(0,l.jsx)(r.p,{children:"This controller provides automatic label management for Kubernetes Services:"}),"\n",(0,l.jsxs)(r.ul,{children:["\n",(0,l.jsxs)(r.li,{children:["\ud83d\udd04 Processes ",(0,l.jsx)(r.strong,{children:"all existing Services"})," in a namespace on startup"]}),"\n",(0,l.jsxs)(r.li,{children:["\ud83d\udc40 Watches for ",(0,l.jsx)(r.strong,{children:"new or updated Services"})," continuously"]}),"\n",(0,l.jsx)(r.li,{children:"\ud83c\udff7\ufe0f Automatically adds target export labels (key + value)"}),"\n",(0,l.jsx)(r.li,{children:"\ud83d\udee1\ufe0f Skips Kubernetes system Services"}),"\n",(0,l.jsxs)(r.li,{children:["\ud83d\ude80 Runs both ",(0,l.jsx)(r.strong,{children:"in-cluster"})," and ",(0,l.jsx)(r.strong,{children:"out-of-cluster"})," (via ",(0,l.jsx)(r.code,{children:"--kubeconfig"}),")"]}),"\n"]}),"\n",(0,l.jsx)(r.h2,{id:"how-it-works",children:"How It Works"}),"\n",(0,l.jsx)(r.mermaid,{value:"graph TB\r\n    A[Start] --\x3e B[Load Config]\r\n    B --\x3e C[Init Client]\r\n    C --\x3e D[Process Services]\r\n    D --\x3e E[Watch Loop]\r\n    E --\x3e F{Event?}\r\n    F --\x3e|Add/Mod| G{Has Label?}\r\n    F --\x3e|Delete| E\r\n    G --\x3e|No| H[Add Label]\r\n    G --\x3e|Yes| E\r\n    H --\x3e E\r\n\r\n    style A fill:#e1f5ff\r\n    style E fill:#fff4e1\r\n    style F fill:#ffe1e1\r\n    style G fill:#ffe1e1\r\n    style H fill:#e1ffe1"}),"\n",(0,l.jsx)(r.h3,{id:"workflow-details",children:"Workflow Details"}),"\n",(0,l.jsxs)(r.ol,{children:["\n",(0,l.jsxs)(r.li,{children:["\n",(0,l.jsx)(r.p,{children:(0,l.jsx)(r.strong,{children:"Startup Phase"})}),"\n",(0,l.jsxs)(r.ul,{children:["\n",(0,l.jsx)(r.li,{children:"Loads configuration from CLI flags"}),"\n",(0,l.jsx)(r.li,{children:"Initializes Kubernetes client (in-cluster or from kubeconfig)"}),"\n",(0,l.jsx)(r.li,{children:"Processes all existing Services in the configured namespace"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(r.li,{children:["\n",(0,l.jsx)(r.p,{children:(0,l.jsx)(r.strong,{children:"Continuous Watch"})}),"\n",(0,l.jsxs)(r.ul,{children:["\n",(0,l.jsxs)(r.li,{children:["Monitors for ",(0,l.jsx)(r.code,{children:"ADDED"}),", ",(0,l.jsx)(r.code,{children:"MODIFIED"}),", and ",(0,l.jsx)(r.code,{children:"DELETED"})," events"]}),"\n",(0,l.jsx)(r.li,{children:"Ensures each Service contains the required export label"}),"\n",(0,l.jsx)(r.li,{children:"Ignores Services already labeled correctly"}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(r.li,{children:["\n",(0,l.jsx)(r.p,{children:(0,l.jsx)(r.strong,{children:"Label Injection"})}),"\n",(0,l.jsxs)(r.ul,{children:["\n",(0,l.jsx)(r.li,{children:"Deep copies the Service object"}),"\n",(0,l.jsx)(r.li,{children:"Adds or updates the label"}),"\n",(0,l.jsx)(r.li,{children:"Performs a Kubernetes API update call"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(r.h2,{id:"configuration",children:"Configuration"}),"\n",(0,l.jsx)(r.h3,{id:"command-line-flags",children:"Command-Line Flags"}),"\n",(0,l.jsxs)(r.table,{children:[(0,l.jsx)(r.thead,{children:(0,l.jsxs)(r.tr,{children:[(0,l.jsx)(r.th,{children:"Flag"}),(0,l.jsx)(r.th,{children:"Default"}),(0,l.jsx)(r.th,{children:"Description"})]})}),(0,l.jsxs)(r.tbody,{children:[(0,l.jsxs)(r.tr,{children:[(0,l.jsx)(r.td,{children:(0,l.jsx)(r.code,{children:"--namespace"})}),(0,l.jsx)(r.td,{children:(0,l.jsx)(r.code,{children:"default"})}),(0,l.jsx)(r.td,{children:"Namespace to monitor for Services"})]}),(0,l.jsxs)(r.tr,{children:[(0,l.jsx)(r.td,{children:(0,l.jsx)(r.code,{children:"--label"})}),(0,l.jsx)(r.td,{children:(0,l.jsx)(r.code,{children:"mirror.linkerd.io/exported"})}),(0,l.jsx)(r.td,{children:"Label key to apply"})]}),(0,l.jsxs)(r.tr,{children:[(0,l.jsx)(r.td,{children:(0,l.jsx)(r.code,{children:"--value"})}),(0,l.jsx)(r.td,{children:(0,l.jsx)(r.code,{children:"true"})}),(0,l.jsx)(r.td,{children:"Label value to apply"})]}),(0,l.jsxs)(r.tr,{children:[(0,l.jsx)(r.td,{children:(0,l.jsx)(r.code,{children:"--kubeconfig"})}),(0,l.jsx)(r.td,{children:(0,l.jsx)(r.em,{children:"(empty)"})}),(0,l.jsx)(r.td,{children:"Path to kubeconfig (optional, for local execution)"})]}),(0,l.jsxs)(r.tr,{children:[(0,l.jsx)(r.td,{children:(0,l.jsx)(r.code,{children:"-v"})}),(0,l.jsx)(r.td,{children:(0,l.jsx)(r.code,{children:"0"})}),(0,l.jsx)(r.td,{children:"Log verbosity level (0-4)"})]})]})]}),"\n",(0,l.jsx)(r.h3,{id:"example-usage",children:"Example Usage"}),"\n",(0,l.jsxs)(t.A,{children:[(0,l.jsx)(a.A,{value:"basic",label:"Basic",default:!0,children:(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-bash",children:"service-auto-exporter \\\r\n  --namespace=emojivoto \\\r\n  --label=mirror.linkerd.io/exported \\\r\n  --value=true\n"})})}),(0,l.jsx)(a.A,{value:"custom",label:"Custom Label",children:(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-bash",children:"service-auto-exporter \\\r\n  --namespace=production \\\r\n  --label=export.custom.io/enabled \\\r\n  --value=yes \\\r\n  -v=2\n"})})}),(0,l.jsx)(a.A,{value:"local",label:"Local Development",children:(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-bash",children:"service-auto-exporter \\\r\n  --kubeconfig=~/.kube/config \\\r\n  --namespace=test \\\r\n  --label=mirror.linkerd.io/exported \\\r\n  --value=true \\\r\n  -v=2\n"})})})]}),"\n",(0,l.jsx)(r.h2,{id:"deployment",children:"Deployment"}),"\n",(0,l.jsx)(r.h3,{id:"kubernetes-deployment",children:"Kubernetes Deployment"}),"\n",(0,l.jsx)(r.p,{children:"Deploy the controller with full RBAC configuration:"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-yaml",children:'---\r\napiVersion: v1\r\nkind: Namespace\r\nmetadata:\r\n  name: defog\r\n  annotations:\r\n    linkerd.io/inject: enabled\r\n---\r\napiVersion: v1\r\nkind: ServiceAccount\r\nmetadata:\r\n  name: service-auto-exporter\r\n  namespace: defog\r\n---\r\napiVersion: rbac.authorization.k8s.io/v1\r\nkind: ClusterRole\r\nmetadata:\r\n  name: service-auto-exporter\r\nrules:\r\n  - apiGroups: [""]\r\n    resources: ["services"]\r\n    verbs: ["get", "list", "watch", "update", "patch"]\r\n---\r\napiVersion: rbac.authorization.k8s.io/v1\r\nkind: ClusterRoleBinding\r\nmetadata:\r\n  name: service-auto-exporter\r\nroleRef:\r\n  apiGroup: rbac.authorization.k8s.io\r\n  kind: ClusterRole\r\n  name: service-auto-exporter\r\nsubjects:\r\n  - kind: ServiceAccount\r\n    name: service-auto-exporter\r\n    namespace: defog\r\n---\r\napiVersion: v1\r\nkind: ConfigMap\r\nmetadata:\r\n  name: service-auto-exporter-config\r\n  namespace: defog\r\ndata:\r\n  TARGET_NAMESPACE: "test"\r\n  EXPORT_LABEL: "to-export"\r\n  EXPORT_VALUE: "true"\r\n---\r\napiVersion: apps/v1\r\nkind: Deployment\r\nmetadata:\r\n  name: service-auto-exporter\r\n  namespace: defog\r\n  labels:\r\n    app: service-auto-exporter\r\nspec:\r\n  replicas: 1\r\n  selector:\r\n    matchLabels:\r\n      app: service-auto-exporter\r\n  template:\r\n    metadata:\r\n      labels:\r\n        app: service-auto-exporter\r\n    spec:\r\n      serviceAccountName: service-auto-exporter\r\n      containers:\r\n        - name: controller\r\n          image: aprountzos/service-auto-exporter:v1\r\n          imagePullPolicy: IfNotPresent\r\n          args:\r\n            - -namespace=$(TARGET_NAMESPACE)\r\n            - -label=$(EXPORT_LABEL)\r\n            - -value=$(EXPORT_VALUE)\r\n            - -v=2\r\n          env:\r\n            - name: TARGET_NAMESPACE\r\n              valueFrom:\r\n                configMapKeyRef:\r\n                  name: service-auto-exporter-config\r\n                  key: TARGET_NAMESPACE\r\n            - name: EXPORT_LABEL\r\n              valueFrom:\r\n                configMapKeyRef:\r\n                  name: service-auto-exporter-config\r\n                  key: EXPORT_LABEL\r\n            - name: EXPORT_VALUE\r\n              valueFrom:\r\n                configMapKeyRef:\r\n                  name: service-auto-exporter-config\r\n                  key: EXPORT_VALUE\r\n          resources:\r\n            requests:\r\n              cpu: 100m\r\n              memory: 64Mi\r\n            limits:\r\n              cpu: 200m\r\n              memory: 128Mi\n'})}),"\n",(0,l.jsx)(r.h3,{id:"apply-the-deployment",children:"Apply the Deployment"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-bash",children:"kubectl apply -f service-auto-exporter.yaml\n"})}),"\n",(0,l.jsx)(r.h3,{id:"verify-deployment",children:"Verify Deployment"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-bash",children:"# Check controller pod status\r\nkubectl get pods -n defog -l app=service-auto-exporter\r\n\r\n# View controller logs\r\nkubectl logs -n defog -l app=service-auto-exporter -f\r\n\r\n# Verify services are being labeled\r\nkubectl get services -n test --show-labels\n"})}),"\n",(0,l.jsx)(r.h2,{id:"behavior--features",children:"Behavior & Features"}),"\n",(0,l.jsx)(r.h3,{id:"-processes-existing-services",children:"\u2705 Processes Existing Services"}),"\n",(0,l.jsx)(r.p,{children:"On startup, all Services in the target namespace are scanned. If a Service is missing the configured label, the controller updates it immediately."}),"\n",(0,l.jsx)(r.h3,{id:"-watches-for-newupdated-services",children:"\u2705 Watches for New/Updated Services"}),"\n",(0,l.jsxs)(r.p,{children:["Using a Kubernetes ",(0,l.jsx)(r.code,{children:"watch.Interface"}),", the controller continuously reacts to Service changes:"]}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-go",children:"case watch.Added, watch.Modified:\r\n    // Process and add label if needed\n"})}),"\n",(0,l.jsx)(r.h3,{id:"-skips-system-services",children:"\u2705 Skips System Services"}),"\n",(0,l.jsxs)(r.p,{children:["Services with names beginning with ",(0,l.jsx)(r.code,{children:'"kubernetes"'})," are automatically ignored to prevent interference with cluster internals."]}),"\n",(0,l.jsx)(r.h3,{id:"-safe-updates",children:"\u2705 Safe Updates"}),"\n",(0,l.jsx)(r.p,{children:"Services are deep-copied before modification to prevent race conditions:"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-go",children:"updatedSvc := svc.DeepCopy()\n"})}),"\n",(0,l.jsx)(r.p,{children:"The controller only updates Services when the label is missing or incorrect, avoiding unnecessary API calls."}),"\n",(0,l.jsx)(r.h2,{id:"use-cases",children:"Use Cases"}),"\n",(0,l.jsx)(r.p,{children:"The Service Auto-Exporter is particularly useful when:"}),"\n",(0,l.jsxs)(r.ul,{children:["\n",(0,l.jsxs)(r.li,{children:["\u2728 You need ",(0,l.jsx)(r.strong,{children:"automatic propagation"})," of labels required by service mesh or multicluster tools"]}),"\n",(0,l.jsx)(r.li,{children:"\ud83d\udc65 Developers frequently create Services, making consistent labeling difficult"}),"\n",(0,l.jsx)(r.li,{children:"\ud83c\udfaf You want a minimal controller without the overhead of a full operator framework"}),"\n",(0,l.jsxs)(r.li,{children:["\ud83d\udd17 You're using ",(0,l.jsx)(r.strong,{children:"Linkerd multicluster"})," and need automatic service export"]}),"\n",(0,l.jsx)(r.li,{children:"\ud83c\udfe2 You have compliance requirements for service labeling across namespaces"}),"\n"]}),"\n",(0,l.jsx)(r.h2,{id:"example-behavior",children:"Example Behavior"}),"\n",(0,l.jsxs)(r.table,{children:[(0,l.jsx)(r.thead,{children:(0,l.jsxs)(r.tr,{children:[(0,l.jsx)(r.th,{children:"Service Name"}),(0,l.jsx)(r.th,{children:"Before"}),(0,l.jsx)(r.th,{children:"After"})]})}),(0,l.jsxs)(r.tbody,{children:[(0,l.jsxs)(r.tr,{children:[(0,l.jsx)(r.td,{children:(0,l.jsx)(r.code,{children:"web-svc"})}),(0,l.jsx)(r.td,{children:"No label"}),(0,l.jsxs)(r.td,{children:[(0,l.jsx)(r.code,{children:"mirror.linkerd.io/exported=true"})," \u2705"]})]}),(0,l.jsxs)(r.tr,{children:[(0,l.jsx)(r.td,{children:(0,l.jsx)(r.code,{children:"redis"})}),(0,l.jsx)(r.td,{children:"Incorrect label value"}),(0,l.jsx)(r.td,{children:"Updated to correct value \u2705"})]}),(0,l.jsxs)(r.tr,{children:[(0,l.jsx)(r.td,{children:(0,l.jsx)(r.code,{children:"kubernetes"})}),(0,l.jsx)(r.td,{children:"System service"}),(0,l.jsx)(r.td,{children:"Ignored (no changes) \u23ed\ufe0f"})]}),(0,l.jsxs)(r.tr,{children:[(0,l.jsx)(r.td,{children:(0,l.jsx)(r.code,{children:"api-gateway"})}),(0,l.jsx)(r.td,{children:"Already correct"}),(0,l.jsx)(r.td,{children:"No update needed \u23ed\ufe0f"})]})]})]}),"\n",(0,l.jsx)(r.h2,{id:"architecture",children:"Architecture"}),"\n",(0,l.jsx)(r.h3,{id:"code-structure",children:"Code Structure"}),"\n",(0,l.jsx)(r.p,{children:"The controller is organized into clean, focused components:"}),"\n",(0,l.jsx)(r.h4,{id:"config",children:"Config"}),"\n",(0,l.jsx)(r.p,{children:"Holds CLI options and configuration parameters."}),"\n",(0,l.jsx)(r.h4,{id:"controller",children:"Controller"}),"\n",(0,l.jsx)(r.p,{children:"Contains the Kubernetes client and core logic for processing Services."}),"\n",(0,l.jsx)(r.h4,{id:"key-methods",children:"Key Methods"}),"\n",(0,l.jsxs)(r.ul,{children:["\n",(0,l.jsxs)(r.li,{children:[(0,l.jsx)(r.code,{children:"Run(ctx)"})," \u2014 Orchestrates startup and watch loop"]}),"\n",(0,l.jsxs)(r.li,{children:[(0,l.jsx)(r.code,{children:"processExistingServices()"})," \u2014 Scans all existing Services on startup"]}),"\n",(0,l.jsxs)(r.li,{children:[(0,l.jsx)(r.code,{children:"watchServices()"})," \u2014 Watches Service events continuously"]}),"\n",(0,l.jsxs)(r.li,{children:[(0,l.jsx)(r.code,{children:"processService()"})," \u2014 Applies the export label to a Service"]}),"\n"]}),"\n",(0,l.jsx)(r.h2,{id:"logging",children:"Logging"}),"\n",(0,l.jsxs)(r.p,{children:["The controller uses ",(0,l.jsx)(r.code,{children:"klog"})," for structured logging with configurable verbosity."]}),"\n",(0,l.jsx)(r.h3,{id:"log-levels",children:"Log Levels"}),"\n",(0,l.jsxs)(t.A,{children:[(0,l.jsx)(a.A,{value:"minimal",label:"Minimal (-v=0)",default:!0,children:(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-bash",children:"# Only errors and critical information\r\nservice-auto-exporter --namespace=test -v=0\n"})})}),(0,l.jsx)(a.A,{value:"normal",label:"Normal (-v=1)",children:(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-bash",children:"# Standard operational logs\r\nservice-auto-exporter --namespace=test -v=1\n"})})}),(0,l.jsx)(a.A,{value:"verbose",label:"Verbose (-v=2)",children:(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-bash",children:"# Detailed operation logs (recommended)\r\nservice-auto-exporter --namespace=test -v=2\n"})})})]}),"\n",(0,l.jsx)(r.h3,{id:"example-log-output",children:"Example Log Output"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-log",children:"I Starting Service Auto-Exporter Controller\r\nI Target namespace: emojivoto\r\nI Export label: mirror.linkerd.io/exported=true\r\nI Processed 3 existing services\r\nI Adding export label to service: web-svc\r\nI Successfully added export label to service: web-svc\r\nI Watching for service changes...\n"})}),"\n",(0,l.jsx)(r.h2,{id:"development",children:"Development"}),"\n",(0,l.jsx)(r.h3,{id:"building-from-source",children:"Building from Source"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-bash",children:"# Clone repository\r\ngit clone https://github.com/yourusername/service-auto-exporter\r\ncd service-auto-exporter\r\n\r\n# Build binary\r\ngo build -o service-auto-exporter\r\n\r\n# Run locally\r\n./service-auto-exporter --kubeconfig ~/.kube/config --namespace default\n"})}),"\n",(0,l.jsx)(r.h3,{id:"running-locally",children:"Running Locally"}),"\n",(0,l.jsx)(r.p,{children:"For local development and testing:"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-bash",children:"go run main.go \\\r\n  --kubeconfig ~/.kube/config \\\r\n  --namespace test \\\r\n  --label mirror.linkerd.io/exported \\\r\n  --value true \\\r\n  -v=2\n"})}),"\n",(0,l.jsx)(r.h3,{id:"testing",children:"Testing"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-bash",children:"# Run unit tests\r\ngo test ./...\r\n\r\n# Run with race detector\r\ngo test -race ./...\n"})}),"\n",(0,l.jsx)(r.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,l.jsx)(r.h3,{id:"controller-not-starting",children:"Controller not starting"}),"\n",(0,l.jsx)(r.p,{children:"Check RBAC permissions:"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-bash",children:"kubectl auth can-i update services --as=system:serviceaccount:defog:service-auto-exporter\n"})}),"\n",(0,l.jsx)(r.h3,{id:"services-not-being-labeled",children:"Services not being labeled"}),"\n",(0,l.jsxs)(r.ol,{children:["\n",(0,l.jsxs)(r.li,{children:["\n",(0,l.jsx)(r.p,{children:"Verify the controller is running:"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-bash",children:"kubectl get pods -n defog -l app=service-auto-exporter\n"})}),"\n"]}),"\n",(0,l.jsxs)(r.li,{children:["\n",(0,l.jsx)(r.p,{children:"Check controller logs:"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-bash",children:"kubectl logs -n defog -l app=service-auto-exporter\n"})}),"\n"]}),"\n",(0,l.jsxs)(r.li,{children:["\n",(0,l.jsx)(r.p,{children:"Verify target namespace exists:"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-bash",children:"kubectl get namespace test\n"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(r.h3,{id:"permission-errors",children:"Permission errors"}),"\n",(0,l.jsx)(r.p,{children:"Ensure ClusterRole includes all required verbs:"}),"\n",(0,l.jsx)(r.pre,{children:(0,l.jsx)(r.code,{className:"language-yaml",children:'verbs: ["get", "list", "watch", "update", "patch"]\n'})}),"\n",(0,l.jsx)(r.h2,{id:"faq",children:"FAQ"}),"\n",(0,l.jsxs)(n,{children:[(0,l.jsx)("summary",{children:"Can I monitor multiple namespaces?"}),(0,l.jsx)(r.p,{children:"Currently, the controller monitors a single namespace. Deploy multiple instances with different configurations to monitor multiple namespaces."})]}),"\n",(0,l.jsxs)(n,{children:[(0,l.jsx)("summary",{children:"What happens if I change the label key or value?"}),(0,l.jsx)(r.p,{children:"The controller will update all Services with the new label on its next reconciliation pass. Old labels are not automatically removed."})]}),"\n",(0,l.jsxs)(n,{children:[(0,l.jsx)("summary",{children:"Does this work with Istio or other service meshes?"}),(0,l.jsx)(r.p,{children:"Yes! While designed for Linkerd, you can configure any label key/value pair, making it compatible with any system requiring Service labels."})]}),"\n",(0,l.jsxs)(n,{children:[(0,l.jsx)("summary",{children:"How much overhead does this add?"}),(0,l.jsx)(r.p,{children:"Minimal. The controller uses Kubernetes watch mechanisms (not polling) and only updates Services when necessary. Resource usage is typically under 100m CPU and 64Mi memory."})]}),"\n",(0,l.jsx)(r.h2,{id:"contributing",children:"Contributing"}),"\n",(0,l.jsx)(r.p,{children:"Contributions are welcome! Please feel free to submit issues or pull requests."}),"\n",(0,l.jsx)(r.h2,{id:"license",children:"License"}),"\n",(0,l.jsx)(r.p,{children:"[Your License Here]"}),"\n",(0,l.jsx)(r.hr,{}),"\n",(0,l.jsxs)(r.p,{children:[(0,l.jsx)(r.strong,{children:"Questions or issues?"})," Please open an issue on ",(0,l.jsx)(r.a,{href:"https://github.com/yourusername/service-auto-exporter",children:"GitHub"}),"."]})]})}function p(e={}){const{wrapper:r}={...(0,i.R)(),...e.components};return r?(0,l.jsx)(r,{...e,children:(0,l.jsx)(h,{...e})}):h(e)}},8453:(e,r,n)=>{n.d(r,{R:()=>t,x:()=>a});var s=n(6540);const l={},i=s.createContext(l);function t(e){const r=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function a(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:t(e.components),s.createElement(i.Provider,{value:r},e.children)}},9365:(e,r,n)=>{n.d(r,{A:()=>t});n(6540);var s=n(4164);const l={tabItem:"tabItem_Ymn6"};var i=n(4848);function t({children:e,hidden:r,className:n}){return(0,i.jsx)("div",{role:"tabpanel",className:(0,s.A)(l.tabItem,n),hidden:r,children:e})}}}]);