"use strict";(globalThis.webpackChunkdefogv_2_wiki=globalThis.webpackChunkdefogv_2_wiki||[]).push([[3109],{8453:(e,r,n)=>{n.d(r,{R:()=>a,x:()=>c});var t=n(6540);const s={},i=t.createContext(s);function a(e){const r=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function c(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),t.createElement(i.Provider,{value:r},e.children)}},8544:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>o,contentTitle:()=>c,default:()=>h,frontMatter:()=>a,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"architecture/components/orchestrator","title":"Orchestrator","description":"The brain - coordinates all decisions and peer communication","source":"@site/docs/architecture/components/orchestrator.mdx","sourceDirName":"architecture/components","slug":"/architecture/components/orchestrator","permalink":"/defogv2-wiki/docs/architecture/components/orchestrator","draft":false,"unlisted":false,"editUrl":"https://github.com/aprountzos/defogv2-wiki/tree/main/docs/docs/architecture/components/orchestrator.mdx","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"title":"Orchestrator","description":"The brain - coordinates all decisions and peer communication","sidebar_position":4},"sidebar":"tutorialSidebar","previous":{"title":"Scheduler","permalink":"/defogv2-wiki/docs/architecture/components/scheduler"},"next":{"title":"Executor","permalink":"/defogv2-wiki/docs/architecture/components/executor"}}');var s=n(4848),i=n(8453);const a={title:"Orchestrator",description:"The brain - coordinates all decisions and peer communication",sidebar_position:4},c="Orchestrator",o={},l=[{value:"Overview",id:"overview",level:2},{value:"Purpose",id:"purpose",level:2},{value:"State Management",id:"state-management",level:2},{value:"Service State",id:"service-state",level:3},{value:"Peer Cluster State",id:"peer-cluster-state",level:3},{value:"Pending Actions",id:"pending-actions",level:3},{value:"Event Processing",id:"event-processing",level:2},{value:"Main Event Loop",id:"main-event-loop",level:3},{value:"Stress Event Handler",id:"stress-event-handler",level:3},{value:"RPS Event Handler",id:"rps-event-handler",level:3},{value:"Peer Communication",id:"peer-communication",level:2},{value:"Querying Peer Capacity",id:"querying-peer-capacity",level:3},{value:"Requesting Deployment",id:"requesting-deployment",level:3},{value:"Traffic Management",id:"traffic-management",level:2},{value:"Adjusting Traffic Splits",id:"adjusting-traffic-splits",level:3},{value:"Gradual Traffic Shifting",id:"gradual-traffic-shifting",level:3},{value:"Configuration",id:"configuration",level:2},{value:"Peer Configuration",id:"peer-configuration",level:3},{value:"API Endpoints",id:"api-endpoints",level:2},{value:"POST /events/stress",id:"post-eventsstress",level:3},{value:"POST /events/rps/high",id:"post-eventsrpshigh",level:3},{value:"POST /events/rps/low",id:"post-eventsrpslow",level:3},{value:"GET /state",id:"get-state",level:3},{value:"Deployment",id:"deployment",level:2},{value:"Operational Characteristics",id:"operational-characteristics",level:2},{value:"Resource Usage",id:"resource-usage",level:3},{value:"Scaling",id:"scaling",level:3},{value:"Monitoring",id:"monitoring",level:2},{value:"Prometheus Metrics",id:"prometheus-metrics",level:3},{value:"Alerts",id:"alerts",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Issue: Events Not Processing",id:"issue-events-not-processing",level:3},{value:"Issue: Peer Communication Failing",id:"issue-peer-communication-failing",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"Source Code Reference",id:"source-code-reference",level:2},{value:"Related Documentation",id:"related-documentation",level:2}];function d(e){const r={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(r.header,{children:(0,s.jsx)(r.h1,{id:"orchestrator",children:"Orchestrator"})}),"\n",(0,s.jsxs)(r.p,{children:["The Orchestrator is the ",(0,s.jsx)(r.strong,{children:"coordination center"})," of Defog v2. It receives events from the Monitor, consults the Scheduler for decisions, commands the Executor to take actions, and communicates with peer clusters when necessary."]}),"\n",(0,s.jsx)(r.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsx)(r.mermaid,{value:"graph TB\r\n    subgraph Inputs\r\n        MON[Monitor Events]\r\n        PEER[Peer Responses]\r\n    end\r\n    \r\n    subgraph Orchestrator\r\n        EH[Event Handler]\r\n        STATE[State Manager]\r\n        PC[Peer Coordinator]\r\n        DM[Decision Manager]\r\n    end\r\n    \r\n    subgraph Outputs\r\n        SCHED[Scheduler]\r\n        EXEC[Executor]\r\n        PEERS[Peer APIs]\r\n    end\r\n    \r\n    MON --\x3e EH\r\n    PEER --\x3e EH\r\n    EH --\x3e STATE\r\n    STATE --\x3e DM\r\n    DM --\x3e PC\r\n    \r\n    DM --\x3e SCHED\r\n    SCHED --\x3e DM\r\n    DM --\x3e EXEC\r\n    PC --\x3e PEERS\r\n    \r\n    style EH fill:#e1f5ff\r\n    style STATE fill:#fff4e1\r\n    style DM fill:#ffe1e1"}),"\n",(0,s.jsx)(r.h2,{id:"purpose",children:"Purpose"}),"\n",(0,s.jsxs)(r.p,{children:["The Orchestrator is the ",(0,s.jsx)(r.strong,{children:"only stateful service"})," in Defog v2, responsible for:"]}),"\n",(0,s.jsxs)(r.ol,{children:["\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"Event Processing"})," - Handle stress and RPS events"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"State Management"})," - Track services, traffic splits, deployments"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"Decision Coordination"})," - Consult Scheduler and execute actions"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"Peer Communication"})," - Coordinate with remote clusters"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"Strategy Execution"})," - Implement both stress and RPS strategies"]}),"\n"]}),"\n",(0,s.jsx)(r.h2,{id:"state-management",children:"State Management"}),"\n",(0,s.jsx)(r.p,{children:"The Orchestrator maintains state about:"}),"\n",(0,s.jsx)(r.h3,{id:"service-state",children:"Service State"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:"type ServiceState struct {\r\n    Name      string\r\n    Namespace string\r\n    \r\n    // Stress tracking (for stress strategy)\r\n    CurrentStress     float64\r\n    TrafficSplitLocal int  // current % to local\r\n    LastStressCheck   time.Time\r\n    \r\n    // RPS tracking (for RPS strategy)\r\n    CurrentRPS        float64\r\n    AvgRPS            float64\r\n    LowRPSCandidate   bool\r\n    LastRPS           float64\r\n    LastRPSCheck      time.Time\r\n    \r\n    // Deployment status\r\n    DeployedLocally   bool\r\n    Replicas          int\r\n    MirrorTarget      string  // which cluster hosts mirror\r\n}\n"})}),"\n",(0,s.jsx)(r.h3,{id:"peer-cluster-state",children:"Peer Cluster State"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:"type PeerClusterInfo struct {\r\n    ClusterID   string\r\n    APIEndpoint string\r\n    Region      string\r\n    LastHealthy time.Time\r\n    LastLatency time.Duration\r\n    Capacity    *CapacityReport\r\n    FailureCount int\r\n}\n"})}),"\n",(0,s.jsx)(r.h3,{id:"pending-actions",children:"Pending Actions"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:"type PendingAction struct {\r\n    ID          string\r\n    Type        string  // deploy, delete, scale, traffic_split\r\n    ServiceName string\r\n    TargetCluster string\r\n    CreatedAt   time.Time\r\n    Status      string  // pending, executing, completed, failed\r\n}\n"})}),"\n",(0,s.jsx)(r.h2,{id:"event-processing",children:"Event Processing"}),"\n",(0,s.jsx)(r.h3,{id:"main-event-loop",children:"Main Event Loop"}),"\n",(0,s.jsx)(r.mermaid,{value:"sequenceDiagram\r\n    participant M as Monitor\r\n    participant O as Orchestrator\r\n    participant S as Scheduler\r\n    participant E as Executor\r\n    \r\n    Note over O: Event Loop Running\r\n    \r\n    loop Continuously\r\n        alt StressEvent\r\n            M->>O: StressEvent\r\n            O->>O: Update service state\r\n            O->>S: Calculate traffic split\r\n            S--\x3e>O: Split decision\r\n            O->>E: UpdateTrafficSplit\r\n            Note over O: Stress strategy executed\r\n        else HighRPSEvent\r\n            M->>O: HighRPSEvent\r\n            O->>O: Check if already local\r\n            O->>O: Check capacity\r\n            O->>S: Need eviction?\r\n            S--\x3e>O: Eviction decision\r\n            O->>E: Delete/Deploy\r\n            Note over O: RPS strategy executed\r\n        else LowRPSEvent\r\n            M->>O: LowRPSEvent\r\n            O->>O: Mark as candidate\r\n            Note over O: Stored for later\r\n        end\r\n    end"}),"\n",(0,s.jsx)(r.h3,{id:"stress-event-handler",children:"Stress Event Handler"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:'func (o *Orchestrator) handleStress(ctx context.Context, event StressEvent) {\r\n    log.Printf("STRESS: %s has %.2f CPU stress", event.ServiceName, event.CPUStress)\r\n    \r\n    // 1. Update service state\r\n    o.mu.Lock()\r\n    if state, exists := o.localServices[event.ServiceName]; exists {\r\n        state.CurrentStress = event.CPUStress\r\n        state.LastStressCheck = time.Now()\r\n    } else {\r\n        o.localServices[event.ServiceName] = &ServiceState{\r\n            Name:          event.ServiceName,\r\n            Namespace:     event.Namespace,\r\n            CurrentStress: event.CPUStress,\r\n        }\r\n    }\r\n    o.mu.Unlock()\r\n    \r\n    // 2. Calculate traffic split via Scheduler\r\n    decision := o.schedulerClient.CalculateSplit(ctx, event.CPUStress)\r\n    \r\n    // 3. Execute traffic split\r\n    o.adjustTrafficSplit(ctx, event.ServiceName, event.Namespace, decision.MirrorPercent)\r\n}\n'})}),"\n",(0,s.jsx)(r.h3,{id:"rps-event-handler",children:"RPS Event Handler"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:'func (o *Orchestrator) handleHighRPS(ctx context.Context, event HighRPSEvent) {\r\n    log.Printf("HIGH RPS: %s (mirrored) has %.2f RPS", event.ServiceName, event.CurrentRPS)\r\n    \r\n    // Only act on mirrored services\r\n    if event.IsLocal {\r\n        return\r\n    }\r\n    \r\n    // 1. Check if already deployed locally\r\n    if o.hasLocalDeployment(event.ServiceName) {\r\n        log.Printf("Service %s already local, considering scaling", event.ServiceName)\r\n        o.considerScaling(ctx, event.ServiceName, event.CurrentRPS)\r\n        return\r\n    }\r\n    \r\n    // 2. Check local capacity\r\n    capacity := o.getLocalCapacity(ctx)\r\n    \r\n    if o.hasEnoughCapacity(capacity) {\r\n        // Deploy locally\r\n        o.deployServiceLocally(ctx, event.ServiceName, event.Namespace)\r\n        return\r\n    }\r\n    \r\n    // 3. Try to make space via LFU\r\n    decision := o.tryMakeSpace(ctx, event.ServiceName)\r\n    \r\n    if decision.CanMakeSpace {\r\n        // Evict low RPS service, then deploy\r\n        for _, svc := range decision.ServicesToDelete {\r\n            o.deleteServiceLocally(ctx, svc, event.Namespace)\r\n        }\r\n        o.deployServiceLocally(ctx, event.ServiceName, event.Namespace)\r\n        return\r\n    }\r\n    \r\n    // 4. Cannot make space - ask peers\r\n    o.askPeerToDeploy(ctx, event.ServiceName, event.Namespace)\r\n}\n'})}),"\n",(0,s.jsx)(r.h2,{id:"peer-communication",children:"Peer Communication"}),"\n",(0,s.jsx)(r.h3,{id:"querying-peer-capacity",children:"Querying Peer Capacity"}),"\n",(0,s.jsx)(r.mermaid,{value:"sequenceDiagram\r\n    participant O as Orchestrator\r\n    participant P1 as Peer Cluster B\r\n    participant P2 as Peer Cluster C\r\n    \r\n    Note over O: Need peer capacity\r\n    \r\n    par Query all peers\r\n        O->>P1: GET /peer/v1/capacity\r\n        P1--\x3e>O: {freeCpu: 4.5, ...}\r\n    and\r\n        O->>P2: GET /peer/v1/capacity\r\n        P2--\x3e>O: {freeCpu: 2.0, ...}\r\n    end\r\n    \r\n    Note over O: Aggregate results\r\n    O->>O: Score clusters\r\n    Note over O: Best: Cluster B"}),"\n",(0,s.jsx)(r.h3,{id:"requesting-deployment",children:"Requesting Deployment"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:'func (o *Orchestrator) askPeerToDeploy(ctx context.Context, serviceName, namespace string) {\r\n    log.Printf("Asking peers to deploy %s", serviceName)\r\n    \r\n    rpsMetrics := o.getRPSForService(serviceName)\r\n    \r\n    req := CanDeployRequest{\r\n        ServiceName:   serviceName,\r\n        Namespace:     namespace,\r\n        SourceCluster: o.config.ClusterID,\r\n        CurrentRPS:    rpsMetrics.CurrentRPS,\r\n        Resources:     o.getServiceResources(serviceName),\r\n    }\r\n    \r\n    // Try peers in order of preference\r\n    for clusterID, peerClient := range o.peerClients {\r\n        resp, err := peerClient.CanDeploy(ctx, req)\r\n        if err != nil {\r\n            log.Printf("Failed to ask %s: %v", clusterID, err)\r\n            continue\r\n        }\r\n        \r\n        switch resp.Status {\r\n        case "already_have_it":\r\n            log.Printf("%s already has %s deployed", clusterID, serviceName)\r\n            o.updateTrafficRouting(ctx, serviceName, namespace, clusterID)\r\n            return\r\n            \r\n        case "will_deploy":\r\n            log.Printf("%s will deploy %s", clusterID, serviceName)\r\n            // Wait for confirmation, then update traffic\r\n            o.waitForPeerDeployment(ctx, clusterID, serviceName)\r\n            o.updateTrafficRouting(ctx, serviceName, namespace, clusterID)\r\n            return\r\n            \r\n        case "cannot_deploy":\r\n            log.Printf("%s cannot deploy: %s", clusterID, resp.Reason)\r\n            continue\r\n        }\r\n    }\r\n    \r\n    log.Printf("No peer cluster can deploy %s", serviceName)\r\n}\n'})}),"\n",(0,s.jsx)(r.h2,{id:"traffic-management",children:"Traffic Management"}),"\n",(0,s.jsx)(r.h3,{id:"adjusting-traffic-splits",children:"Adjusting Traffic Splits"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:'func (o *Orchestrator) adjustTrafficSplit(ctx context.Context, serviceName, namespace string, mirrorPercent int) {\r\n    localPercent := 100 - mirrorPercent\r\n    \r\n    log.Printf("Adjusting traffic for %s: %d%% local, %d%% mirror", \r\n        serviceName, localPercent, mirrorPercent)\r\n    \r\n    req := TrafficSplitRequest{\r\n        ServiceName: serviceName,\r\n        Namespace:   namespace,\r\n        Backends: []TrafficBackend{\r\n            {Service: serviceName, Weight: localPercent},\r\n            {Service: serviceName + "-mirrored", Weight: mirrorPercent},\r\n        },\r\n    }\r\n    \r\n    if err := o.executorClient.UpdateTrafficSplit(ctx, req); err != nil {\r\n        log.Printf("Failed to update traffic split: %v", err)\r\n        return\r\n    }\r\n    \r\n    // Update state\r\n    o.mu.Lock()\r\n    if state, exists := o.localServices[serviceName]; exists {\r\n        state.TrafficSplitLocal = localPercent\r\n    }\r\n    o.mu.Unlock()\r\n    \r\n    log.Printf("Traffic split updated successfully")\r\n}\n'})}),"\n",(0,s.jsx)(r.h3,{id:"gradual-traffic-shifting",children:"Gradual Traffic Shifting"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-go",children:"func (o *Orchestrator) gradualShift(ctx context.Context, serviceName, namespace string, targetPercent int) {\r\n    currentState := o.getServiceState(serviceName)\r\n    currentPercent := currentState.TrafficSplitLocal\r\n    \r\n    increment := o.config.TrafficSplitIncrement  // e.g., 10%\r\n    \r\n    // Gradually shift traffic\r\n    for current := currentPercent; current != targetPercent; {\r\n        if targetPercent > current {\r\n            current = min(current + increment, targetPercent)\r\n        } else {\r\n            current = max(current - increment, targetPercent)\r\n        }\r\n        \r\n        mirrorPercent := 100 - current\r\n        o.adjustTrafficSplit(ctx, serviceName, namespace, mirrorPercent)\r\n        \r\n        // Wait between shifts\r\n        time.Sleep(o.config.TrafficShiftDelay)\r\n    }\r\n}\n"})}),"\n",(0,s.jsx)(r.h2,{id:"configuration",children:"Configuration"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-yaml",children:'apiVersion: v1\r\nkind: ConfigMap\r\nmetadata:\r\n  name: defog-config\r\n  namespace: defog-system\r\ndata:\r\n  # Cluster identity\r\n  CLUSTER_ID: "cluster-a"\r\n  REGION: "us-west-2"\r\n  \r\n  # Service URLs\r\n  MONITOR_URL: "http://resource-monitor:8080"\r\n  SCHEDULER_URL: "http://scheduler:8080"\r\n  EXECUTOR_URL: "http://executor:8080"\r\n  \r\n  # Behavior\r\n  TRAFFIC_SPLIT_INCREMENT: "10"\r\n  TRAFFIC_SHIFT_DELAY: "10s"\r\n  EVENT_QUEUE_SIZE: "1000"\r\n  \r\n  # Peer health\r\n  HEALTH_CHECK_INTERVAL: "60s"\r\n  PEER_TIMEOUT: "30s"\r\n  MAX_PEER_FAILURES: "3"\n'})}),"\n",(0,s.jsx)(r.h3,{id:"peer-configuration",children:"Peer Configuration"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-yaml",children:'apiVersion: v1\r\nkind: Secret\r\nmetadata:\r\n  name: peer-cluster-config\r\n  namespace: defog-system\r\nstringData:\r\n  clusters.json: |\r\n    [\r\n      {\r\n        "id": "cluster-b",\r\n        "apiEndpoint": "https://cluster-b-executor.example.com",\r\n        "region": "us-east-1",\r\n        "token": "eyJhbGciOiJIUzI1NiIs...",\r\n        "priority": 1\r\n      },\r\n      {\r\n        "id": "cluster-c",\r\n        "apiEndpoint": "https://cluster-c-executor.example.com",\r\n        "region": "eu-west-1",\r\n        "token": "eyJhbGciOiJIUzI1NiIs...",\r\n        "priority": 2\r\n      }\r\n    ]\n'})}),"\n",(0,s.jsx)(r.h2,{id:"api-endpoints",children:"API Endpoints"}),"\n",(0,s.jsx)(r.h3,{id:"post-eventsstress",children:"POST /events/stress"}),"\n",(0,s.jsx)(r.p,{children:"Receive stress event from Monitor."}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.strong,{children:"Request"}),":"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-json",children:'{\r\n  "serviceName": "api",\r\n  "namespace": "default",\r\n  "podName": "api-pod-1",\r\n  "cpuStress": 0.85,\r\n  "memoryStress": 0.70,\r\n  "stressLevel": "high"\r\n}\n'})}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.strong,{children:"Response"}),": ",(0,s.jsx)(r.code,{children:"202 Accepted"})]}),"\n",(0,s.jsx)(r.hr,{}),"\n",(0,s.jsx)(r.h3,{id:"post-eventsrpshigh",children:"POST /events/rps/high"}),"\n",(0,s.jsx)(r.p,{children:"Receive high RPS event."}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.strong,{children:"Request"}),":"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-json",children:'{\r\n  "serviceName": "payments-mirrored",\r\n  "namespace": "default",\r\n  "isLocal": false,\r\n  "currentRps": 500.0,\r\n  "threshold": 300.0\r\n}\n'})}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.strong,{children:"Response"}),": ",(0,s.jsx)(r.code,{children:"202 Accepted"})]}),"\n",(0,s.jsx)(r.hr,{}),"\n",(0,s.jsx)(r.h3,{id:"post-eventsrpslow",children:"POST /events/rps/low"}),"\n",(0,s.jsx)(r.p,{children:"Receive low RPS event."}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.strong,{children:"Request"}),":"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-json",children:'{\r\n  "serviceName": "old-api",\r\n  "namespace": "default",\r\n  "isLocal": true,\r\n  "currentRps": 8.0,\r\n  "threshold": 10.0\r\n}\n'})}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.strong,{children:"Response"}),": ",(0,s.jsx)(r.code,{children:"202 Accepted"})]}),"\n",(0,s.jsx)(r.hr,{}),"\n",(0,s.jsx)(r.h3,{id:"get-state",children:"GET /state"}),"\n",(0,s.jsx)(r.p,{children:"Get current orchestrator state."}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.strong,{children:"Response"}),":"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-json",children:'{\r\n  "localServices": {\r\n    "api": {\r\n      "currentStress": 0.75,\r\n      "trafficSplitLocal": 80,\r\n      "currentRps": 450,\r\n      "deployedLocally": true,\r\n      "replicas": 3\r\n    }\r\n  },\r\n  "mirroredServices": {\r\n    "payments": {\r\n      "sourceCluster": "cluster-b",\r\n      "trafficSplit": 100,\r\n      "deployedAt": "2024-01-15T10:00:00Z"\r\n    }\r\n  },\r\n  "peerClusters": {\r\n    "cluster-b": {\r\n      "healthy": true,\r\n      "lastHealthy": "2024-01-15T10:30:00Z",\r\n      "capacity": {\r\n        "freeCpu": 4.5,\r\n        "freeMemory": 8.0\r\n      }\r\n    }\r\n  }\r\n}\n'})}),"\n",(0,s.jsx)(r.h2,{id:"deployment",children:"Deployment"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-yaml",children:"apiVersion: apps/v1\r\nkind: Deployment\r\nmetadata:\r\n  name: orchestrator\r\n  namespace: defog-system\r\nspec:\r\n  replicas: 1  # Should be 1 (stateful)\r\n  selector:\r\n    matchLabels:\r\n      app: orchestrator\r\n  template:\r\n    metadata:\r\n      labels:\r\n        app: orchestrator\r\n    spec:\r\n      serviceAccountName: defog-controller\r\n      containers:\r\n      - name: orchestrator\r\n        image: registry.io/defog-orchestrator:v2.0.0\r\n        ports:\r\n        - containerPort: 8080\r\n          name: http\r\n        envFrom:\r\n        - configMapRef:\r\n            name: defog-config\r\n        env:\r\n        - name: PEER_CLUSTERS\r\n          valueFrom:\r\n            secretKeyRef:\r\n              name: peer-cluster-config\r\n              key: clusters.json\r\n        resources:\r\n          requests:\r\n            cpu: 200m\r\n            memory: 256Mi\r\n          limits:\r\n            cpu: 500m\r\n            memory: 512Mi\r\n        livenessProbe:\r\n          httpGet:\r\n            path: /health\r\n            port: 8080\r\n          initialDelaySeconds: 10\r\n          periodSeconds: 30\r\n        readinessProbe:\r\n          httpGet:\r\n            path: /health\r\n            port: 8080\r\n          initialDelaySeconds: 5\r\n          periodSeconds: 10\r\n---\r\napiVersion: v1\r\nkind: Service\r\nmetadata:\r\n  name: orchestrator\r\n  namespace: defog-system\r\nspec:\r\n  selector:\r\n    app: orchestrator\r\n  ports:\r\n  - port: 8080\r\n    targetPort: 8080\n"})}),"\n",(0,s.jsx)(r.h2,{id:"operational-characteristics",children:"Operational Characteristics"}),"\n",(0,s.jsx)(r.h3,{id:"resource-usage",children:"Resource Usage"}),"\n",(0,s.jsxs)(r.table,{children:[(0,s.jsx)(r.thead,{children:(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.th,{children:"Metric"}),(0,s.jsx)(r.th,{children:"Value"})]})}),(0,s.jsxs)(r.tbody,{children:[(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"CPU"}),(0,s.jsx)(r.td,{children:"150-200m (avg), 500m (max)"})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"Memory"}),(0,s.jsx)(r.td,{children:"200-256Mi (stable)"})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"Event Processing"}),(0,s.jsx)(r.td,{children:"100+ events/min"})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:"Peer API Calls"}),(0,s.jsx)(r.td,{children:"5-20/min"})]})]})]}),"\n",(0,s.jsx)(r.h3,{id:"scaling",children:"Scaling"}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.strong,{children:"Important"}),": The Orchestrator should ",(0,s.jsx)(r.strong,{children:"NOT"})," be scaled horizontally due to stateful nature. For high availability:"]}),"\n",(0,s.jsxs)(r.ol,{children:["\n",(0,s.jsxs)(r.li,{children:["Use ",(0,s.jsx)(r.code,{children:"replicas: 1"})," with leader election (future)"]}),"\n",(0,s.jsx)(r.li,{children:"Or use active-passive setup"}),"\n",(0,s.jsx)(r.li,{children:"State can be externalized to database (future)"}),"\n"]}),"\n",(0,s.jsx)(r.h2,{id:"monitoring",children:"Monitoring"}),"\n",(0,s.jsx)(r.h3,{id:"prometheus-metrics",children:"Prometheus Metrics"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-promql",children:'# Events processed\r\nrate(defog_orchestrator_events_total{type="StressEvent"}[5m])\r\nrate(defog_orchestrator_events_total{type="HighRPSEvent"}[5m])\r\n\r\n# Event queue size\r\ndefog_orchestrator_queue_size\r\n\r\n# Peer API latency\r\nhistogram_quantile(0.95, defog_peer_api_duration_seconds)\r\n\r\n# Peer failures\r\nrate(defog_peer_failures_total[5m])\r\n\r\n# Actions executed\r\nrate(defog_orchestrator_actions_total{action="deploy"}[5m])\n'})}),"\n",(0,s.jsx)(r.h3,{id:"alerts",children:"Alerts"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-yaml",children:'groups:\r\n- name: defog-orchestrator\r\n  rules:\r\n  - alert: OrchestratorDown\r\n    expr: up{job="orchestrator"} == 0\r\n    for: 2m\r\n    annotations:\r\n      summary: "Orchestrator is down"\r\n  \r\n  - alert: EventQueueBackup\r\n    expr: defog_orchestrator_queue_size > 100\r\n    for: 5m\r\n    annotations:\r\n      summary: "Event queue backing up"\r\n  \r\n  - alert: HighPeerFailures\r\n    expr: rate(defog_peer_failures_total[5m]) > 0.2\r\n    for: 10m\r\n    annotations:\r\n      summary: "High peer communication failure rate"\n'})}),"\n",(0,s.jsx)(r.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,s.jsx)(r.h3,{id:"issue-events-not-processing",children:"Issue: Events Not Processing"}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.strong,{children:"Check event queue"}),":"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"kubectl exec -n defog-system deployment/orchestrator -- \\\r\n  curl localhost:8080/state | jq '.queueSize'\n"})}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.strong,{children:"Check logs"}),":"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:'kubectl logs -n defog-system deployment/orchestrator | grep "ERROR"\n'})}),"\n",(0,s.jsx)(r.h3,{id:"issue-peer-communication-failing",children:"Issue: Peer Communication Failing"}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.strong,{children:"Test connectivity"}),":"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"kubectl exec -it -n defog-system deployment/orchestrator -- \\\r\n  curl -v https://cluster-b-executor.example.com/peer/v1/health\n"})}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.strong,{children:"Check peer state"}),":"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"kubectl exec -n defog-system deployment/orchestrator -- \\\r\n  curl localhost:8080/state | jq '.peerClusters'\n"})}),"\n",(0,s.jsx)(r.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,s.jsxs)(r.ol,{children:["\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"Run single replica"})," - Orchestrator is stateful"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"Monitor event queue"})," - Alert if backing up"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"Set peer timeouts"})," - Prevent hanging requests"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"Log all decisions"})," - For debugging and auditing"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"Use circuit breakers"})," - For peer communication"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"Health check peers"})," - Regularly verify connectivity"]}),"\n"]}),"\n",(0,s.jsx)(r.h2,{id:"source-code-reference",children:"Source Code Reference"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:"internal/orchestrator/\r\n\u251c\u2500\u2500 server.go          # HTTP server\r\n\u251c\u2500\u2500 handlers.go        # Event handlers\r\n\u251c\u2500\u2500 state.go           # State management\r\n\u251c\u2500\u2500 peer_client.go     # Peer communication\r\n\u251c\u2500\u2500 traffic.go         # Traffic management\r\n\u2514\u2500\u2500 clients.go         # Scheduler & Executor clients\r\n\r\npkg/api/\r\n\u2514\u2500\u2500 types.go           # Event types\n"})}),"\n",(0,s.jsx)(r.h2,{id:"related-documentation",children:"Related Documentation"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.a,{href:"../dual-strategy",children:"Dual-Strategy Design"})," - How strategies are coordinated"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.a,{href:"./monitor",children:"Metrics Monitor"})," - Event source"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.a,{href:"./scheduler",children:"Scheduler"})," - Decision provider"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.a,{href:"./executor",children:"Executor"})," - Action executor"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.a,{href:"../api",children:"API Reference"})," - Complete API specs"]}),"\n"]})]})}function h(e={}){const{wrapper:r}={...(0,i.R)(),...e.components};return r?(0,s.jsx)(r,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}}}]);